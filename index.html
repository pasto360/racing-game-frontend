<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garage Racing Manager - Cloud Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0a;
            --bg-card: #1a1a1a;
            --accent-red: #ff3333;
            --accent-yellow: #ffd700;
            --accent-cyan: #00d9ff;
            --accent-green: #00ff88;
            --accent-purple: #9d4edd;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255, 51, 51, 0.03) 2px, rgba(255, 51, 51, 0.03) 4px);
            pointer-events: none;
            z-index: 1;
        }

        .container { max-width: 1600px; margin: 0 auto; padding: 20px; position: relative; z-index: 2; }

        /* ===== NUOVO LAYOUT COMPATTO CON IMMAGINI ===== */
        .page-container {
            max-width: 880px;
            margin: 0 auto;
            padding: 10px;
        }

        .section-layout {
            display: grid;
            grid-template-columns: 110px 600px 120px;
            gap: 8px;
            margin-bottom: 12px;
            align-items: start;
        }

        .side-menu {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .side-menu-btn {
            padding: 12px 8px;
            font-size: 0.85rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--accent-cyan);
            border-radius: 5px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            line-height: 1.3;
            min-height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .side-menu-btn:hover {
            background: var(--accent-cyan);
            color: var(--bg-dark);
            transform: translateX(2px);
        }

        .side-menu-btn.active {
            background: var(--accent-yellow);
            color: var(--bg-dark);
            border-color: var(--accent-yellow);
        }

        .section-image-container {
            position: relative;
            width: 600px;
            height: 280px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--accent-cyan);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
        }

        .section-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            display: block;
        }

        .section-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, transparent 0%, rgba(10, 10, 10, 0.7) 100%);
            display: flex;
            align-items: flex-end;
            padding: 15px;
        }

        .section-title-overlay {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--accent-cyan);
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        .side-stats {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--accent-cyan);
            border-radius: 5px;
            padding: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-yellow);
        }

        .upgrade-buttons-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .upgrade-btn-compact {
            padding: 10px 8px;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid var(--accent-yellow);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .upgrade-btn-compact:hover {
            background: var(--accent-yellow);
            color: var(--bg-dark);
            transform: translateY(-2px);
        }

        .upgrade-btn-compact:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Mobile responsive */
        @media (max-width: 1024px) {
            .section-layout {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .section-image-container {
                width: 100%;
                height: 220px;
            }

            .side-menu {
                flex-direction: row;
                overflow-x: auto;
                padding-bottom: 5px;
            }

            .side-menu-btn {
                min-width: 90px;
            }

            .side-stats {
                flex-direction: row;
                overflow-x: auto;
            }

            .stat-box {
                min-width: 90px;
            }

            .upgrade-buttons-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .section-title-overlay {
                font-size: 1.3rem;
            }
        }

        header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(180deg, rgba(26, 26, 26, 0.9) 0%, transparent 100%);
            border-bottom: 2px solid var(--accent-red);
            margin-bottom: 20px;
            animation: slideDown 0.8s ease-out;
            position: relative;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #666, #333);
            border: 2px solid #888;
            color: white;
            padding: 10px 20px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            border-color: var(--accent-red);
            box-shadow: 0 0 20px rgba(255, 51, 51, 0.5);
        }

        @keyframes slideDown {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 6px;
            background: linear-gradient(135deg, var(--accent-red) 0%, var(--accent-yellow) 50%, var(--accent-cyan) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .resources {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .resource-card {
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px 16px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
        }

        .resource-card:hover {
            border-color: var(--accent-red);
            box-shadow: 0 0 20px rgba(255, 51, 51, 0.3);
            transform: translateY(-2px);
        }

        .resource-icon { font-size: 1.3rem; }

        .resource-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .resource-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .resource-rate {
            font-size: 0.65rem;
            color: var(--accent-green);
        }

        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 255, 136, 0.2);
            border: 2px solid var(--accent-green);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .save-indicator.show {
            opacity: 1;
        }

        @media (max-width: 1024px) {
            /* Nascondi indicatore salvataggio su mobile (copre tab bar) */
            .save-indicator {
                display: none;
            }
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            padding: 15px 30px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            border-color: var(--accent-red);
            box-shadow: 0 0 30px rgba(255, 51, 51, 0.3);
            transform: translateY(-3px);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--accent-red), #cc0000);
            border-color: var(--accent-red);
            box-shadow: 0 0 30px rgba(255, 51, 51, 0.3);
        }

        .nav-btn .icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 5px;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .page.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 4px;
            margin: 30px 0 20px 0;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--accent-red);
            position: relative;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 100px;
            height: 3px;
            background: var(--accent-yellow);
        }

        .workshop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 40px;
        }

        .workshop-section {
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .workshop-section:hover {
            border-color: var(--accent-yellow);
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.2);
            transform: scale(1.02);
        }

        .workshop-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .workshop-icon {
            font-size: 2.5rem;
            margin-right: 15px;
        }

        .workshop-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .workshop-level span {
            background: linear-gradient(135deg, var(--accent-red), var(--accent-yellow));
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
            letter-spacing: 1px;
            display: inline-block;
            margin-bottom: 15px;
        }

        .workshop-stats {
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .workshop-stats div {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }

        .btn {
            background: linear-gradient(135deg, var(--accent-red), #cc0000);
            border: none;
            color: white;
            padding: 10px 24px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            box-shadow: 0 0 30px rgba(255, 51, 51, 0.6);
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #333;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn:disabled:hover {
            box-shadow: none;
            transform: none;
        }

        .btn-success { background: linear-gradient(135deg, var(--accent-green), #00cc66); }
        .btn-cyan { background: linear-gradient(135deg, var(--accent-cyan), #0099cc); }
        .btn-purple { background: linear-gradient(135deg, var(--accent-purple), #7209b7); }
        .btn-small {
            padding: 8px 20px;
            font-size: 0.9rem;
            width: auto;
        }

        .car-card {
            background: var(--bg-card);
            border: 2px solid rgba(0, 217, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .car-card:hover {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 40px rgba(0, 217, 255, 0.3);
        }

        .car-card.damaged {
            border-color: var(--accent-red);
            background: linear-gradient(135deg, rgba(255, 51, 51, 0.05), transparent);
        }

        .car-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .car-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .car-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-red), var(--accent-yellow));
            border-radius: 6px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            to { left: 100%; }
        }

        .locked {
            opacity: 0.4;
            filter: grayscale(1);
        }

        .unlock-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--accent-red), var(--accent-yellow));
            padding: 20px 30px;
            border-radius: 10px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 51, 51, 0.8);
            z-index: 1000;
            animation: slideInOut 3s ease-out forwards;
        }

        @keyframes slideInOut {
            0% { transform: translateX(400px); opacity: 0; }
            10% { transform: translateX(0); opacity: 1; }
            90% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(400px); opacity: 0; }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--bg-card);
            border: 3px solid var(--accent-red);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.5s ease-out;
            box-shadow: 0 0 100px rgba(255, 51, 51, 0.5);
        }

        @keyframes scaleIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .empty-garage {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            font-size: 1.2rem;
        }

        .empty-garage-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .dealer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 40px;
        }

        .team-card {
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            transition: all 0.3s ease;
            text-align: center;
        }

        .team-card:hover {
            border-color: var(--accent-purple);
            box-shadow: 0 0 40px rgba(157, 78, 221, 0.3);
            transform: scale(1.02);
        }

        .team-card.active {
            border-color: var(--accent-green);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), transparent);
        }

        .tech-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .tech-card {
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            text-align: center;
        }

        .tech-card:hover {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.3);
            transform: scale(1.02);
        }

        .tech-card.researched {
            border-color: var(--accent-green);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), transparent);
        }

        .modal-content.win {
            border-color: var(--accent-green) !important;
            box-shadow: 0 0 100px rgba(0, 255, 136, 0.5) !important;
        }

        .modal-content.win .modal-title {
            color: var(--accent-green) !important;
        }

        footer {
            text-align: center;
            padding: 30px;
            margin-top: 50px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ===== CSS PER POPUP GARE ===== */
        .race-car {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
        }

        .race-car-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
            color: var(--accent-cyan);
        }

        .race-car-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .race-car-stat:last-child {
            border-bottom: none;
        }

        .reward-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 5px;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .damage-indicator {
            background: rgba(255, 51, 51, 0.1);
            border: 2px solid var(--accent-red);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .damage-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-red);
            margin: 10px 0;
        }

        /* ===== CSS PER STORICO GARE ===== */
        .championship-race {
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .championship-race:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }

        .championship-race.win {
            border-color: var(--accent-green);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), transparent);
        }

        .championship-race.lose {
            border-color: var(--accent-red);
            background: linear-gradient(135deg, rgba(255, 51, 51, 0.05), transparent);
        }

        .championship-race.completed {
            opacity: 0.9;
        }

        .championship-progress {
            background: var(--bg-card);
            border: 2px solid var(--accent-purple);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        /* ===== CSS PER SELEZIONE AUTO GARE ===== */
        .car-select-btn {
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 150px;
        }

        .car-select-btn:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }

        .car-select-btn.active {
            border-color: var(--accent-green);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), transparent);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .car-select-btn.damaged {
            border-color: var(--accent-red);
        }

        /* ===== CSS PER STATISTICHE GARE ===== */
        .race-stat {
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .race-stat:hover {
            border-color: var(--accent-cyan);
            transform: scale(1.05);
        }

        .race-stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 900;
            color: var(--accent-yellow);
            margin-bottom: 10px;
        }

        .race-stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ===== CSS PER COSTI ===== */
        .cost-display {
            text-align: center;
            margin-top: 10px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* ===== MOBILE TAB BAR ===== */
        .mobile-tab-bar {
            display: none;
        }

        .mobile-overflow-menu {
            display: none;
        }

        @media (max-width: 1024px) {
            /* Nascondi navigazione desktop su mobile */
            .navigation {
                display: none !important;
            }

            /* Mostra tab bar mobile */
            .mobile-tab-bar {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(180deg, rgba(26, 26, 26, 0.98) 0%, rgba(10, 10, 10, 0.98) 100%);
                border-top: 2px solid var(--accent-red);
                padding: 8px 0 max(8px, env(safe-area-inset-bottom));
                z-index: 1000;
                justify-content: space-around;
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
            }

            .mobile-tab-btn {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                background: none;
                border: none;
                color: var(--text-secondary);
                padding: 6px 8px;
                cursor: pointer;
                transition: all 0.3s ease;
                flex: 1;
                max-width: 80px;
            }

            .mobile-tab-btn .icon {
                font-size: 1.5rem;
                margin-bottom: 2px;
            }

            .mobile-tab-btn span:not(.icon) {
                font-size: 0.65rem;
                font-family: 'Rajdhani', sans-serif;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .mobile-tab-btn.active {
                color: var(--accent-red);
            }

            .mobile-tab-btn.active .icon {
                transform: scale(1.1);
            }

            /* Menu overflow mobile */
            .mobile-overflow-menu {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 2500;
            }

            .mobile-overflow-menu.active {
                display: block;
            }

            .mobile-menu-backdrop {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
            }

            .mobile-menu-content {
                position: absolute;
                bottom: 70px;
                left: 0;
                right: 0;
                background: linear-gradient(180deg, rgba(26, 26, 26, 0.98) 0%, rgba(10, 10, 10, 0.98) 100%);
                border-top: 2px solid var(--accent-red);
                padding: 10px;
                animation: slideUp 0.3s ease-out;
            }

            @keyframes slideUp {
                from { transform: translateY(100%); }
                to { transform: translateY(0); }
            }

            .mobile-menu-item {
                display: flex;
                align-items: center;
                gap: 15px;
                width: 100%;
                background: none;
                border: none;
                color: var(--text-primary);
                padding: 15px 20px;
                font-family: 'Rajdhani', sans-serif;
                font-size: 1.1rem;
                font-weight: 600;
                text-align: left;
                cursor: pointer;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                transition: all 0.3s ease;
            }

            .mobile-menu-item:last-child {
                border-bottom: none;
            }

            .mobile-menu-item:active {
                background: rgba(255, 51, 51, 0.2);
            }

            .mobile-menu-item .icon {
                font-size: 1.8rem;
            }

            /* Aggiungi padding bottom al container per non far coprire contenuto dalla tab bar */
            .container {
                padding-bottom: 80px;
            }

            /* Riduci dimensioni card su mobile */
            .workshop-section,
            .car-card,
            .tech-card {
                padding: 15px;
            }
            
            .team-card {
                padding: 15px;
            }
            
            .team-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .team-card .icon,
            .team-card > div:first-child {
                font-size: 2rem !important;
                margin-bottom: 8px !important;
            }
            
            .team-card > div {
                font-size: 0.9rem;
            }

            .section-title {
                font-size: 1.3rem;
                margin: 20px 0 15px 0;
            }

            /* Riduci dimensioni pulsanti su mobile */
            .btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            /* Header piÃ¹ compatto */
            header {
                padding: 15px 10px;
            }

            h1 {
                font-size: 1.5rem;
                letter-spacing: 3px;
            }

            .resource-card {
                min-width: 110px;
                padding: 6px 12px;
            }

            .logout-btn {
                padding: 8px 15px;
                font-size: 0.8rem;
                top: 15px;
                right: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="save-indicator" id="saveIndicator">ğŸ’¾ Salvataggio...</div>
    
    <div class="container" id="gameContainer" style="display: none;">
        <header>
            <button class="logout-btn" onclick="handleLogout()">ğŸšª LOGOUT</button>
            <h1>Garage Racing Manager</h1>
            <div class="resources" id="resources"></div>
        </header>

        <nav class="navigation">
            <button class="nav-btn active" onclick="game.changePage('workshop')">
                <span class="icon">ğŸ”§</span>
                Officina
            </button>
            <button class="nav-btn" onclick="game.changePage('garage')">
                <span class="icon">ğŸï¸</span>
                Garage + Team
            </button>
            <button class="nav-btn" onclick="game.changePage('dealer')">
                <span class="icon">ğŸª</span>
                Concessionario
            </button>
            <button class="nav-btn" onclick="game.changePage('tech')">
                <span class="icon">ğŸ”¬</span>
                Tecnologie
            </button>
            <button class="nav-btn" onclick="game.changePage('race')">
                <span class="icon">ğŸ</span>
                Gare
            </button>
            <button class="nav-btn" onclick="game.changePage('leaderboard')">
               <span class="icon">ğŸ†</span>
               Classifica
            </button>
        </nav>

        <!-- Mobile Tab Bar (visibile solo su mobile) -->
        <nav class="mobile-tab-bar">
            <button class="mobile-tab-btn active" onclick="game.changePage('workshop')">
                <span class="icon">ğŸ”§</span>
                <span>Shop</span>
            </button>
            <button class="mobile-tab-btn" onclick="game.changePage('garage')">
                <span class="icon">ğŸï¸</span>
                <span>Auto</span>
            </button>
            <button class="mobile-tab-btn" onclick="game.changePage('race')">
                <span class="icon">ğŸ</span>
                <span>Gare</span>
            </button>
            <button class="mobile-tab-btn" onclick="toggleMobileMenu()">
                <span class="icon">â‹®</span>
                <span>Altro</span>
            </button>
        </nav>

        <!-- Menu overflow mobile -->
        <div id="mobileMenu" class="mobile-overflow-menu">
            <div class="mobile-menu-backdrop" onclick="closeMobileMenu()"></div>
            <div class="mobile-menu-content">
                <button class="mobile-menu-item" onclick="game.changePage('dealer'); closeMobileMenu()">
                    <span class="icon">ğŸª</span>
                    <span>Concessionario</span>
                </button>
                <button class="mobile-menu-item" onclick="game.changePage('tech'); closeMobileMenu()">
                    <span class="icon">ğŸ”¬</span>
                    <span>Tecnologie</span>
                </button>
                <button class="mobile-menu-item" onclick="game.changePage('leaderboard'); closeMobileMenu()">
                    <span class="icon">ğŸ†</span>
                    <span>Classifica</span>
                </button>
            </div>
        </div>

        <div id="page-workshop" class="page active">
            <h2 class="section-title">ğŸ”§ Reparti Officina</h2>
            <div class="workshop-grid" id="workshop"></div>
        </div>

        <div id="page-garage" class="page">
            <h2 class="section-title">ğŸï¸ Le Mie Auto</h2>
            <div id="myGarage"></div>
            
            <h2 class="section-title">ğŸ‘¤ Il Mio Team</h2>
            <h3 style="font-family: Orbitron; font-size: 1.3rem; margin: 20px 0 15px 0; color: var(--accent-purple);">Pilota</h3>
            <div class="team-grid" id="driversSection"></div>
            
            <h3 style="font-family: Orbitron; font-size: 1.3rem; margin: 30px 0 15px 0; color: var(--accent-yellow);">Sponsor</h3>
            <div class="team-grid" id="sponsorsSection"></div>
        </div>

        <div id="page-dealer" class="page">
            <h2 class="section-title">ğŸª Auto Disponibili</h2>
            <div class="dealer-grid" id="dealerCars"></div>
        </div>

        <div id="page-tech" class="page">
            <h2 class="section-title">ğŸ”¬ Albero Tecnologie</h2>
            <div class="tech-grid" id="techTree"></div>
        </div>

        <div id="page-race" class="page">
            <h2 class="section-title">ğŸ Seleziona Auto</h2>
            <div id="carSelector" style="display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap;"></div>
            
            <h2 class="section-title">ğŸ Gare Stradali</h2>
            <div id="raceInfo" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;"></div>
            <button class="btn btn-success" onclick="game.startRace()" id="raceBtn">Inizia Gara Stradale</button>
            
            <h2 class="section-title">ğŸ† Campionato (5 Gare)</h2>
            <div id="championshipSection"></div>
            
            <h2 class="section-title">ğŸ“œ Log Ultime Gare</h2>
            <div id="raceHistoryInline"></div>
        </div>

        
        <div id="page-leaderboard" class="page">
            <h2 class="section-title">ğŸ† Classifica Mondiale</h2>
            <div id="leaderboardContainer"></div>
        </div>
    </div>

    <div class="modal" id="raceModal">
        <div class="modal-content">
            <h2 class="modal-title" id="raceResult" style="font-size: 2.5rem; font-weight: 900; text-align: center; margin-bottom: 30px;"></h2>
            <div id="raceComparison" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;"></div>
            <div id="raceRewards"></div>
            <div id="damageSection"></div>
            <button class="btn" onclick="game.closeRaceModal()">Chiudi</button>
        </div>
    </div>

    <div class="modal" id="repairModal">
        <div class="modal-content">
            <h2 style="font-family: Orbitron; font-size: 2rem; text-align: center; color: var(--accent-red); margin-bottom: 30px;">ğŸ”§ Riparazione Auto</h2>
            <div id="repairContent"></div>
        </div>
    </div>

    <!-- Modal Conferma Sfida PvP -->
    <div class="modal" id="challengeModal">
        <div class="modal-content" style="max-width: 500px;">
            <h2 style="font-family: Orbitron; font-size: 2rem; text-align: center; color: var(--accent-yellow); margin-bottom: 20px;">âš”ï¸ SFIDA PVP</h2>
            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                <div style="text-align: center; font-size: 1.3rem; margin-bottom: 20px; color: var(--text-primary);">
                    <strong id="challengeOpponentName"></strong>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div style="text-align: center; padding: 15px; background: rgba(0,255,136,0.1); border: 2px solid var(--accent-green); border-radius: 8px;">
                        <div style="font-size: 0.85rem; color: #a0a0a0; margin-bottom: 5px;">SE VINCI</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-green);">+5%</div>
                        <div style="font-size: 0.8rem; margin-top: 5px;">delle sue risorse</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(255,51,51,0.1); border: 2px solid var(--accent-red); border-radius: 8px;">
                        <div style="font-size: 0.85rem; color: #a0a0a0; margin-bottom: 5px;">SE PERDI</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-red);">-10%</div>
                        <div style="font-size: 0.8rem; margin-top: 5px;">delle tue risorse</div>
                    </div>
                </div>
                <div style="text-align: center; padding: 12px; background: rgba(0,217,255,0.1); border: 1px solid var(--accent-cyan); border-radius: 8px; font-size: 0.9rem;">
                    âš¡ Costo: <strong>20 Energia</strong>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <button class="btn" style="background: rgba(255,255,255,0.1); color: #a0a0a0;" onclick="game.closeChallengeModal()">Annulla</button>
                <button class="btn" onclick="game.confirmChallenge()">âš”ï¸ Sfida!</button>
            </div>
        </div>
    </div>

    <footer>
        Garage Racing Manager - Cloud Edition v5.0 â€¢ 100% Online
    </footer>

    <script>
// ===== CONFIGURAZIONE CLOUD =====
const API_URL = 'https://racing-game-backend-production-a5dd.up.railway.app';
let authToken = localStorage.getItem('authToken');
let currentUser = JSON.parse(localStorage.getItem('user') || 'null');

console.log('ğŸ® Cloud Edition - Avvio applicazione');
console.log('ğŸ”‘ Token presente:', !!authToken);

// ===== AUTENTICAZIONE =====
function handleLogout() {
    if (confirm('Sei sicuro di voler uscire?')) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('user');
        location.reload();
    }
}

async function showAuthModal() {
    // Controlla stato server prima di mostrare form
    let serverStatus = 'aperto';
    let userCount = 0;
    
    try {
        const statusRes = await fetch(`${API_URL}/api/auth/status`);
        if (statusRes.ok) {
            const data = await statusRes.json();
            serverStatus = data.registrationOpen ? 'aperto' : 'chiuso';
            userCount = data.userCount || 0;
        }
    } catch (err) {
        console.log('Impossibile verificare stato server, assumo aperto');
    }
    
    const statusBadge = serverStatus === 'aperto' 
        ? `<div style="background: linear-gradient(135deg, #00ff88, #00cc66); color: #000; padding: 8px 20px; border-radius: 20px; font-weight: 700; display: inline-block; margin-bottom: 20px;">âœ“ SERVER 1 APERTO</div>`
        : `<div style="background: linear-gradient(135deg, #ff3333, #cc0000); color: #fff; padding: 8px 20px; border-radius: 20px; font-weight: 700; display: inline-block; margin-bottom: 20px;">âœ— SERVER 1 CHIUSO</div>`;
    
    const html = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center;">
            <div style="background: #1a1a1a; padding: 40px; border-radius: 20px; border: 3px solid #ff3333; max-width: 400px; width: 90%;">
                <h2 style="font-family: Orbitron; text-align: center; margin-bottom: 10px; color: #ff3333;">ğŸ RACING GAME CLOUD</h2>
                <div style="text-align: center; margin-bottom: 20px;">
                    ${statusBadge}
                </div>
                
                <div id="loginForm">
                    <input type="text" id="loginUsername" placeholder="Username" style="width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 2px solid #333; background: #0a0a0a; color: white; font-size: 1rem;">
                    <input type="password" id="loginPassword" placeholder="Password" style="width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 2px solid #333; background: #0a0a0a; color: white; font-size: 1rem;">
                    <button onclick="handleLogin()" style="width: 100%; padding: 15px; margin: 10px 0; background: linear-gradient(135deg, #ff3333, #cc0000); border: none; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; font-size: 1rem;">LOGIN</button>
                    <button onclick="showRegisterForm()" style="width: 100%; padding: 15px; margin: 10px 0; background: #333; border: none; border-radius: 8px; color: white; cursor: pointer;" ${serverStatus === 'chiuso' ? 'disabled' : ''}>
                        ${serverStatus === 'chiuso' ? 'Registrazioni chiuse' : 'Registrati'}
                    </button>
                </div>
                
                <div id="registerForm" style="display: none;">
                    ${serverStatus === 'chiuso' ? `
                        <div style="text-align: center; padding: 30px; color: #ff3333;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ”’</div>
                            <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 10px;">Server al completo</div>
                            <div style="font-size: 0.9rem; color: #a0a0a0;">Il Server 1 ha raggiunto il limite massimo di utenti. Nuovi server saranno disponibili presto!</div>
                            <button onclick="showLoginForm()" style="width: 100%; padding: 15px; margin: 20px 0 0 0; background: #333; border: none; border-radius: 8px; color: white; cursor: pointer;">Torna al Login</button>
                        </div>
                    ` : `
                        <input type="text" id="regUsername" placeholder="Username" style="width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 2px solid #333; background: #0a0a0a; color: white; font-size: 1rem;">
                        <input type="email" id="regEmail" placeholder="Email" style="width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 2px solid #333; background: #0a0a0a; color: white; font-size: 1rem;">
                        <input type="password" id="regPassword" placeholder="Password (min 6 caratteri)" style="width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 2px solid #333; background: #0a0a0a; color: white; font-size: 1rem;">
                        <button onclick="handleRegister()" style="width: 100%; padding: 15px; margin: 10px 0; background: linear-gradient(135deg, #00ff88, #00cc66); border: none; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; font-size: 1rem;">REGISTRATI</button>
                        <button onclick="showLoginForm()" style="width: 100%; padding: 15px; margin: 10px 0; background: #333; border: none; border-radius: 8px; color: white; cursor: pointer;">Torna al Login</button>
                    `}
                </div>
                
                <div id="authMessage" style="margin-top: 20px; text-align: center; color: #ff3333;"></div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
}

function showRegisterForm() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
}

function showLoginForm() {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('registerForm').style.display = 'none';
}

async function handleLogin() {
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    const msgEl = document.getElementById('authMessage');
    
    if (!username || !password) {
        msgEl.textContent = 'Compila tutti i campi!';
        return;
    }
    
    try {
        msgEl.textContent = 'Login in corso...';
        msgEl.style.color = '#00ff88';
        
        const response = await fetch(`${API_URL}/api/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            msgEl.style.color = '#ff3333';
            msgEl.textContent = data.error;
            return;
        }
        
        authToken = data.token;
        currentUser = data.user;
        localStorage.setItem('authToken', authToken);
        localStorage.setItem('user', JSON.stringify(currentUser));
        
        msgEl.style.color = '#00ff88';
        msgEl.textContent = 'Login riuscito! Caricamento gioco...';
        
        document.querySelector('[style*="position: fixed"]').remove();
        await game.init();
        
    } catch (error) {
        msgEl.style.color = '#ff3333';
        msgEl.textContent = 'Errore connessione al server';
        console.error('Errore login:', error);
    }
}

async function handleRegister() {
    const username = document.getElementById('regUsername').value;
    const email = document.getElementById('regEmail').value;
    const password = document.getElementById('regPassword').value;
    const msgEl = document.getElementById('authMessage');
    
    if (!username || !email || !password) {
        msgEl.textContent = 'Compila tutti i campi!';
        return;
    }
    
    if (password.length < 6) {
        msgEl.textContent = 'Password troppo corta (minimo 6 caratteri)!';
        return;
    }
    
    try {
        msgEl.textContent = 'Registrazione in corso...';
        msgEl.style.color = '#00ff88';
        
        const response = await fetch(`${API_URL}/api/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, email, password })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            msgEl.style.color = '#ff3333';
            msgEl.textContent = data.error;
            return;
        }
        
        msgEl.style.color = '#00ff88';
        msgEl.textContent = 'Registrazione completata! Ora fai login.';
        setTimeout(showLoginForm, 2000);
        
    } catch (error) {
        msgEl.style.color = '#ff3333';
        msgEl.textContent = 'Errore connessione al server';
        console.error('Errore registrazione:', error);
    }
}

// ===== API CLOUD =====
async function loadGameFromServer(retryCount = 0) {
    try {
        console.log('ğŸ“¥ Caricamento dati dal server...');
        
        const response = await fetch(`${API_URL}/api/game/state`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        // Gestione errore 429 (Too Many Requests)
        if (response.status === 429) {
            if (retryCount < 3) {
                const delay = Math.pow(2, retryCount) * 1000; // 1s, 2s, 4s
                console.log(`â³ Rate limit raggiunto. Riprovo tra ${delay/1000}s...`);
                await new Promise(resolve => setTimeout(resolve, delay));
                return loadGameFromServer(retryCount + 1);
            } else {
                throw new Error('Troppe richieste al server. Riprova tra un minuto.');
            }
        }
        
        if (!response.ok) {
            throw new Error('Errore caricamento');
        }
        
        const data = await response.json();
        console.log('âœ… Dati caricati dal server:', data);
        
        if (data.resources) {
            Object.keys(data.resources).forEach(key => {
                if (game.resources[key]) {
                    game.resources[key].value = data.resources[key].value || 0;
                }
            });
        }
        
        if (data.workshop) {
            Object.keys(data.workshop).forEach(key => {
                if (game.workshop[key]) {
                    game.workshop[key].level = data.workshop[key].level || 0;
                    game.workshop[key].unlocked = data.workshop[key].unlocked || false;
                }
            });
        }
        
        if (data.ownedCars && Array.isArray(data.ownedCars)) {
            game.ownedCars = data.ownedCars.map(serverCar => {
                const templateCar = game.availableCars.find(c => c.name === serverCar.name);
                return {
                    ...serverCar,
                    image: templateCar ? templateCar.image : serverCar.image
                };
            });
        }
        
        if (data.drivers && Array.isArray(data.drivers)) {
            data.drivers.forEach((serverDriver, index) => {
                if (game.drivers[index]) {
                    game.drivers[index].unlocked = serverDriver.unlocked;
                }
            });
        }
        
        game.currentDriver = data.currentDriver;
        
        if (data.sponsors && Array.isArray(data.sponsors)) {
            data.sponsors.forEach((serverSponsor, index) => {
                if (game.sponsors[index]) {
                    game.sponsors[index].unlocked = serverSponsor.unlocked;
                }
            });
        }
        
        game.currentSponsor = data.currentSponsor;
        game.sponsorRacesLeft = data.sponsorRacesLeft || 0;
        
        if (data.technologies && Array.isArray(data.technologies)) {
            data.technologies.forEach((serverTech) => {
                const localTech = game.technologies.find(t => t.id === serverTech.id);
                if (localTech) {
                    localTech.researched = serverTech.researched || false;
                }
            });
        }
        
        game.races = data.races || game.races;
        game.championship = data.championship || game.championship;
        game.raceHistory = data.raceHistory || [];
        
        // PRODUZIONE OFFLINE
        const lastSaveTime = data.lastSaveTime || Date.now();
        const now = Date.now();
        const offlineTime = (now - lastSaveTime) / 1000;
        
        if (offlineTime > 60) {
            console.log(`â° Tempo offline: ${(offlineTime / 60).toFixed(1)} minuti`);
            
            const offlineHours = offlineTime / 3600;
            
            Object.keys(game.workshop).forEach(key => {
                const section = game.workshop[key];
                if (section.level > 0 && section.production) {
                    Object.keys(section.production).forEach(resource => {
                        if (game.resources[resource]) {
                            const productionPerHour = section.production[resource] * section.level;
                            const offlineProduction = productionPerHour * offlineHours;
                            
                            game.resources[resource].value = Math.min(
                                game.resources[resource].value + offlineProduction,
                                game.resources[resource].max
                            );
                        }
                    });
                }
            });
            
            const energyRecovered = offlineTime / 60;
            game.resources.energy.value = Math.min(
                game.resources.energy.value + energyRecovered,
                game.resources.energy.max
            );
            
            const hours = Math.floor(offlineHours);
            const minutes = Math.floor((offlineHours - hours) * 60);
            let timeMsg = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
            
            setTimeout(() => {
                game.showUnlockNotification(`â° Produzione offline: ${timeMsg}`);
            }, 1000);
        }
        
        return true;
        
    } catch (error) {
        console.error('âŒ Errore caricamento dal server:', error);
        return false;
    }
}

let saveTimeout = null;
async function saveGameToServer(showIndicator = true) {
    if (!authToken) return;

    if (saveTimeout) clearTimeout(saveTimeout);

    saveTimeout = setTimeout(async () => {
        try {
            const saveIndicator = document.getElementById('saveIndicator');
            if (showIndicator && saveIndicator) {
                saveIndicator.classList.add('show');
            }

            const response = await fetch(`${API_URL}/api/game/state`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    gameState: {
                        resources: game.resources,
                        workshop: game.workshop,
                        ownedCars: game.ownedCars,
                        drivers: game.drivers,
                        currentDriver: game.currentDriver,
                        sponsors: game.sponsors,
                        currentSponsor: game.currentSponsor,
                        sponsorRacesLeft: game.sponsorRacesLeft,
                        technologies: game.technologies,
                        races: game.races,
                        championship: game.championship,
                        raceHistory: game.raceHistory
                    }
                })
            });

            // Se rate limit, fallisce silenziosamente (riproverÃ  al prossimo salvataggio automatico)
            if (response.status === 429) {
                console.log('â³ Rate limit durante salvataggio. RiproverÃ  automaticamente.');
                if (showIndicator && saveIndicator) {
                    saveIndicator.classList.remove('show');
                }
                return;
            }

            if (!response.ok) throw new Error('Errore salvataggio');

            console.log('ğŸ’¾ Salvataggio completato');

            if (showIndicator && saveIndicator) {
                setTimeout(() => saveIndicator.classList.remove('show'), 1500);
            }

        } catch (error) {
            console.error('âŒ Errore salvataggio:', error);
        }
    }, 500);
}

// Cache leaderboard - 3 aggiornamenti al giorno (ogni 8 ore)
let leaderboardCache = null;
let leaderboardCacheSlot = null; // Slot corrente (es: "2026-02-09-08")

function getLeaderboardSlot() {
    const now = new Date();
    const date = now.toISOString().split('T')[0]; // "2026-02-09"
    const hour = now.getHours();
    
    // Determina slot: 0-7 â†’ 00, 8-15 â†’ 08, 16-23 â†’ 16
    let slotHour;
    if (hour < 8) {
        slotHour = '00';
    } else if (hour < 16) {
        slotHour = '08';
    } else {
        slotHour = '16';
    }
    
    return `${date}-${slotHour}`;
}

function getNextLeaderboardUpdate() {
    const now = new Date();
    const hour = now.getHours();
    
    let nextHour;
    if (hour < 8) {
        nextHour = 8;
    } else if (hour < 16) {
        nextHour = 16;
    } else {
        nextHour = 24; // Mezzanotte
    }
    
    const next = new Date(now);
    if (nextHour === 24) {
        next.setDate(next.getDate() + 1);
        next.setHours(0, 0, 0, 0);
    } else {
        next.setHours(nextHour, 0, 0, 0);
    }
    
    const diff = next - now;
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    
    return `${hours}h ${minutes}m`;
}

async function loadLeaderboard() {
    try {
        const currentSlot = getLeaderboardSlot();
        
        // Se cache valida per questo slot, usa quella
        if (leaderboardCache && leaderboardCacheSlot === currentSlot) {
            console.log(`ğŸ“Š Cache classifica valida (slot ${currentSlot}), prossimo aggiornamento tra ${getNextLeaderboardUpdate()}`);
            return leaderboardCache;
        }
        
        console.log('ğŸ“Š Caricando classifica dal server...');
        const response = await fetch(`${API_URL}/api/game/leaderboard`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!response.ok) throw new Error('Errore caricamento classifica');
        
        const data = await response.json();
        
        // Salva in cache con slot corrente
        leaderboardCache = data;
        leaderboardCacheSlot = currentSlot;
        
        console.log(`âœ… Classifica aggiornata (slot ${currentSlot})! Prossimo aggiornamento tra ${getNextLeaderboardUpdate()}`);
        
        return data;
        
    } catch (error) {
        console.error('Errore caricamento classifica:', error);
        // Se c'Ã¨ cache vecchia, usala comunque
        if (leaderboardCache) {
            console.log('âš ï¸ Usando cache classifica (vecchia) - Server non disponibile');
            return leaderboardCache;
        }
        return null;
    }
}

// ===== FINE CONFIGURAZIONE API =====
        const game = {
    currentPage: 'workshop',
    selectedCarIndex: 0,
        
    resources: {
                money: { value: 15000, rate: 0, max: 999999, icon: 'ğŸ’°', name: 'Denaro' },
                parts: { value: 150, rate: 0, max: 999999, icon: 'ğŸ”©', name: 'Parti' },
                reputation: { value: 0, rate: 0, max: 10000, icon: 'â­', name: 'Reputazione' },
                energy: { value: 100, rate: 0, max: 100, icon: 'âš¡', name: 'Energia' }
            },

            workshop: {
                engine: {
                    name: 'Reparto Motori',
                    icon: 'âš™ï¸',
                    level: 0,
                    maxLevel: 10,
                    cost: { money: 1000, parts: 50 },
                    production: { parts: 2 },
                    unlocked: true
                },
                electronics: {
                    name: 'Elettronica',
                    icon: 'ğŸ’»',
                    level: 0,
                    maxLevel: 10,
                    cost: { money: 1500, parts: 75 },
                    production: { money: 50 },
                    unlocked: false,
                    unlockCondition: { money: 15000 }
                },
                body: {
                    name: 'Carrozzeria',
                    icon: 'ğŸ¨',
                    level: 0,
                    maxLevel: 10,
                    cost: { money: 2000, parts: 100 },
                    oneTimeBonus: { reputation: 10 },
                    unlocked: false,
                    unlockCondition: { reputation: 50 }
                },
                aerodynamics: {
                    name: 'Aerodinamica',
                    icon: 'ğŸŒªï¸',
                    level: 0,
                    maxLevel: 10,
                    cost: { money: 3000, parts: 150 },
                    oneTimeBonus: { reputation: 10 },
                    unlocked: false,
                    unlockCondition: { reputation: 200, money: 25000 }
                }
            },

            availableCars: [
    {
        name: 'Thunderclaw',
        stats: { engine: 45, body: 40, electronics: 35, aero: 30 },
        price: { money: 8000, parts: 50 },
        unlocked: true,
        image: 'https://i.imgur.com/XimKGSN.jpeg'
    },
    {
        name: 'Blaze Reaver',
        stats: { engine: 50, body: 45, electronics: 40, aero: 35 },
        price: { money: 12000, parts: 150 },
        unlocked: true,
        image: 'https://i.imgur.com/fggC2VO.jpeg'
    },
    {
        name: 'Stormfang',
        stats: { engine: 60, body: 50, electronics: 45, aero: 45 },
        price: { money: 18000, parts: 200 },
        unlocked: false,
        unlockCondition: { reputation: 100 },
        image: 'https://i.imgur.com/jeh5oHT.png'
    },
    {
        name: 'Torque Phantom',
        stats: { engine: 65, body: 55, electronics: 50, aero: 50 },
        price: { money: 22000, parts: 250 },
        unlocked: false,
        unlockCondition: { reputation: 200 },
        image: 'https://i.imgur.com/I7i5ZTs.png'
    },
    {
        name: 'Overdrive X7',
        stats: { engine: 80, body: 70, electronics: 75, aero: 65 },
        price: { money: 45000, parts: 400 },
        unlocked: false,
        unlockCondition: { reputation: 500, money: 50000 },
        image: 'https://i.imgur.com/DCBxo6w.png'
    },
    {
        name: 'Razor Apex',
        stats: { engine: 90, body: 85, electronics: 85, aero: 80 },
        price: { money: 75000, parts: 600 },
        unlocked: false,
        unlockCondition: { reputation: 1000, money: 80000 },
        image: 'https://i.imgur.com/zEWYVCD.png'
    }
],

            ownedCars: [],

            raceHistory: [],

            // Storie casuali per popup fine gara
            victoryStories: [],
            defeatStories: [],

            drivers: [
                { name: 'Mario Rossi', icon: 'ğŸƒ', bonus: { type: 'energy', value: -5 }, cost: 5000, description: 'Pilota efficiente', unlocked: true },
                { name: 'Luca Bianchi', icon: 'ğŸ’°', bonus: { type: 'money', value: 0.2 }, cost: 8000, description: 'Porta sponsor', unlocked: true },
                { name: 'Sara Verdi', icon: 'ğŸ”§', bonus: { type: 'repair', value: -0.1 }, cost: 10000, description: 'Esperta meccanica', unlocked: false, unlockCondition: { reputation: 100 } },
                { name: 'Andrea Neri', icon: 'â­', bonus: { type: 'reputation', value: 0.15 }, cost: 12000, description: 'Star del racing', unlocked: false, unlockCondition: { reputation: 200 } },
                { name: 'Paolo Ferrari', icon: 'ğŸ†', bonus: { type: 'winBonus', value: 0.25 }, cost: 20000, description: 'Campione veterano', unlocked: false, unlockCondition: { reputation: 500 } }
            ],

            currentDriver: null,

            sponsors: [
                { name: 'Auto Parts Inc', icon: 'ğŸ”©', bonus: { type: 'parts', value: 0.1 }, unlocked: true, requirement: 0 },
                { name: 'Speed Oil', icon: 'âš™ï¸', bonus: { type: 'money', value: 0.1 }, unlocked: true, requirement: 0 },
                { name: 'Turbo Tyres', icon: 'âš¡', bonus: { type: 'reputation', value: 0.05 }, unlocked: false, requirement: 10 },
                { name: 'Racing Magazine', icon: 'ğŸ“°', bonus: { type: 'reputation', value: 0.1 }, unlocked: false, requirement: 25 },
                { name: 'Performance Chips', icon: 'ğŸ’»', bonus: { type: 'money', value: 0.15 }, unlocked: false, requirement: 50 },
                { name: 'Carbon Fiber Co', icon: 'ğŸï¸', bonus: { type: 'parts', value: 0.15 }, unlocked: false, requirement: 75 },
                { name: 'Energy Drink X', icon: 'âš¡', bonus: { type: 'energy', value: 10 }, unlocked: false, requirement: 100 },
                { name: 'Nitro Systems', icon: 'ğŸš€', bonus: { type: 'winBonus', value: 0.15 }, unlocked: false, requirement: 150 },
                { name: 'Formula Lubricants', icon: 'ğŸ›¢ï¸', bonus: { type: 'repair', value: -0.15 }, unlocked: false, requirement: 200 },
                { name: 'Red Bull Racing', icon: 'ğŸ†', bonus: { type: 'all', value: 0.1 }, unlocked: false, requirement: 300 }
            ],

            currentSponsor: null,
            sponsorRacesLeft: 0,

            technologies: [
                { id: 'turbo', name: 'Turbocompressore', icon: 'ğŸŒªï¸', bonus: { stat: 'engine', value: 5 }, cost: { money: 5000, parts: 200 }, researched: false },
                { id: 'carbon', name: 'Fibra di Carbonio', icon: 'âš«', bonus: { type: 'repair', value: -0.1 }, cost: { money: 8000, parts: 300, reputation: 50 }, researched: false },
                { id: 'ecu', name: 'ECU Avanzata', icon: 'ğŸ’»', bonus: { stat: 'electronics', value: 5 }, cost: { money: 6000, parts: 250 }, researched: false },
                { id: 'aero', name: 'Kit Aerodinamico', icon: 'âœˆï¸', bonus: { stat: 'aero', value: 5 }, cost: { money: 7000, parts: 300, reputation: 30 }, researched: false },
                { id: 'suspension', name: 'Sospensioni Pro', icon: 'ğŸ”§', bonus: { stat: 'body', value: 5 }, cost: { money: 5500, parts: 220 }, researched: false },
                { id: 'nitro', name: 'Sistema Nitro', icon: 'ğŸš€', bonus: { stat: 'engine', value: 8 }, cost: { money: 12000, parts: 500, reputation: 100 }, researched: false, requires: ['turbo'] },
                { id: 'weight', name: 'Alleggerimento', icon: 'âš–ï¸', bonus: { type: 'allStats', value: 3 }, cost: { money: 10000, parts: 400, reputation: 80 }, researched: false },
                { id: 'cooling', name: 'Raffreddamento', icon: 'â„ï¸', bonus: { type: 'repair', value: -0.15 }, cost: { money: 9000, parts: 350, reputation: 60 }, researched: false }
            ],

            races: {
                completed: 0,
                wins: 0,
                lastRaceTime: 0,
                cooldown: 30000
            },

            championship: {
                active: false,
                currentRace: 0,
                totalRaces: 5,
                wins: 0,
                results: [],
                entryFee: 7000,
                prizePool: 5000
            },

            async init() {
    console.log('ğŸ® Inizializzazione gioco...');
    
    // Carica storie per popup gare
    try {
        const victoryRes = await fetch('victory_stories.json');
        this.victoryStories = await victoryRes.json();
        const defeatRes = await fetch('defeat_stories.json');
        this.defeatStories = await defeatRes.json();
        console.log('ğŸ“– Storie caricate:', this.victoryStories.length, 'vittorie,', this.defeatStories.length, 'sconfitte');
    } catch (error) {
        console.error('âš ï¸ Errore caricamento storie:', error);
        // Fallback storie di default
        this.victoryStories = ["Vittoria meritata! Il team esulta."];
        this.defeatStories = ["Sconfitta amara, ma si impara dagli errori."];
    }
    
    const loaded = await loadGameFromServer();
    
    if (!loaded) {
        console.error('âŒ Errore caricamento dati');
        alert('âš ï¸ Impossibile caricare i dati dal server.\n\nSe vedi questo messaggio ripetutamente, aspetta 1 minuto e ricarica la pagina (F5).\n\nProblema: troppe richieste al server.');
        return;
    }
    
    console.log('âœ… Gioco inizializzato');
    
    document.getElementById('gameContainer').style.display = 'block';
    
    this.render();
    this.startGameLoop();
    this.checkUnlocks();
    
    // Salvataggio automatico ogni 10 secondi (silenzioso)
    setInterval(() => {
        saveGameToServer(false);
    }, 10000);
},

            startGameLoop() {
        this.lastTickTime = Date.now();

        setInterval(() => {
            const now = Date.now();
            const deltaSeconds = (now - this.lastTickTime) / 1000;
            this.lastTickTime = now;

            this.updateResources(deltaSeconds);
            this.render();
        }, 1000);
    },

            updateResources(deltaSeconds = 1) {
        Object.keys(this.workshop).forEach(key => {
            const section = this.workshop[key];
            if (section.level > 0 && section.production) {
                Object.keys(section.production).forEach(resource => {
                    if (this.resources[resource]) {
                        const perSecond = (section.production[resource] * section.level) / 3600;
                        this.resources[resource].value = Math.min(
                            this.resources[resource].value + (perSecond * deltaSeconds),
                            this.resources[resource].max
                        );
                    }
                });
            }
        });

        // Energia: recupera 1 punto al minuto
        this.resources.energy.value = Math.min(
            this.resources.energy.value + (deltaSeconds / 60),
            this.resources.energy.max
        );

        if (this.currentSponsor !== null && this.sponsors[this.currentSponsor]) {
            const sponsor = this.sponsors[this.currentSponsor];
            if (sponsor.income) {
                const perSecond = sponsor.income / 3600;
                this.resources.money.value = Math.min(
                    this.resources.money.value + (perSecond * deltaSeconds),
                    this.resources.money.max
                );
            }
        }
    },

            // ===== FIX BUG 2 & 4: nomi funzioni corretti in changePage =====
            changePage(page) {
        console.log('ğŸ”„ Cambio pagina:', page);
        
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.mobile-tab-btn').forEach(b => b.classList.remove('active'));

        document.getElementById(`page-${page}`).classList.add('active');
        
        // Nuova mappatura: workshop, garage, dealer, tech, race, leaderboard (6 pulsanti desktop)
        const desktopPages = ['workshop','garage','dealer','tech','race','leaderboard'];
        const pageIndex = desktopPages.indexOf(page);
        
        // Attiva pulsante in navigazione desktop
        const navButtons = document.querySelectorAll('.nav-btn');
        if (pageIndex >= 0 && navButtons[pageIndex]) {
            navButtons[pageIndex].classList.add('active');
        }
        
        // Attiva pulsante in tab bar mobile (4 pulsanti: workshop=0, garage=1, race=2, altro=3)
        const mobileMapping = {
            'workshop': 0,
            'garage': 1,
            'race': 2,
            // dealer, tech, leaderboard sono nel menu overflow
        };
        
        const mobileButtons = document.querySelectorAll('.mobile-tab-btn');
        if (mobileMapping[page] !== undefined && mobileButtons[mobileMapping[page]]) {
            mobileButtons[mobileMapping[page]].classList.add('active');
        }

        if (page === 'workshop') this.renderWorkshop();
        if (page === 'garage') {
            this.renderOwnedCars();
            this.renderTeam(); // Team integrato in garage
        }
        if (page === 'dealer') this.renderAvailableCars();
        if (page === 'tech') this.renderTech();
        if (page === 'race') {
            this.renderRace();
            try {
                this.renderHistoryInline(); // Storico ultime 10 gare inline
            } catch (error) {
                console.error('Errore renderHistoryInline:', error);
                // Non bloccare il gioco se lo storico fallisce
            }
        }
        if (page === 'leaderboard') this.renderLeaderboard();

        this.currentPage = page;
    },

            upgradeWorkshop(sectionKey) {
                const section = this.workshop[sectionKey];
                if (!section.unlocked || section.level >= section.maxLevel) return;

                const cost = this.getUpgradeCost(section);
                
                if (this.canAfford(cost)) {
                    this.spendResources(cost);
                    section.level++;
                    
                    if (section.reputationBonus) {
                        const bonus = section.reputationBonus * section.level;
                        this.resources.reputation.value = Math.min(
                            this.resources.reputation.value + bonus,
                            this.resources.reputation.max
                        );
                    }
                    
                    if (section.oneTimeBonus && section.oneTimeBonus.reputation) {
                        const bonus = section.oneTimeBonus.reputation;
                        this.resources.reputation.value = Math.min(
                            this.resources.reputation.value + bonus,
                            this.resources.reputation.max
                        );
                    }
                    
                    // âœ… FIX: Aggiorna solo workshop invece di tutto
                    this.updateResourcesDisplay();
                    this.renderWorkshop();
                } else {
                    alert('Risorse insufficienti!');
                }
            },

            getUpgradeCost(section) {
                const multiplier = Math.pow(1.5, section.level);
                const cost = {};
                Object.keys(section.cost).forEach(key => {
                    cost[key] = Math.floor(section.cost[key] * multiplier);
                });
                return cost;
            },

            canAfford(cost) {
                return Object.keys(cost).every(key => 
                    this.resources[key] && this.resources[key].value >= cost[key]
                );
            },

            spendResources(cost) {
                Object.keys(cost).forEach(key => {
                    if (this.resources[key]) {
                        this.resources[key].value -= cost[key];
                    }
                });
            },

            buyCar(carIndex) {
                const car = this.availableCars[carIndex];
                if (!car.unlocked) return;

                const owned = this.ownedCars.some(c => c.name === car.name);
                if (owned) {
                    alert('Possiedi giÃ  questa auto!');
                    return;
                }

                if (this.canAfford(car.price)) {
                    this.spendResources(car.price);
                    this.ownedCars.push({
                        ...car,
                        upgrades: { engine: 0, body: 0, electronics: 0, aero: 0 },
                        condition: 100
                    });
                    this.showUnlockNotification(`ğŸï¸ Acquistata: ${car.name}!`);
                    this.render();
                } else {
                    alert('Fondi insufficienti!');
                }
            },

            sellCar(carIndex) {
                if (!confirm('Sei sicuro di voler vendere questa auto?')) return;
                
                const car = this.ownedCars[carIndex];
                const sellPrice = {
                    money: Math.floor(car.price.money * 0.6),
                    parts: Math.floor(car.price.parts * 0.6)
                };
                
                this.resources.money.value += sellPrice.money;
                this.resources.parts.value += sellPrice.parts;
                
                this.ownedCars.splice(carIndex, 1);
                
                if (this.selectedCarIndex >= this.ownedCars.length) {
                    this.selectedCarIndex = Math.max(0, this.ownedCars.length - 1);
                }
                
                this.showUnlockNotification(`ğŸ’° Venduta per ${sellPrice.money}â‚¬ + ${sellPrice.parts} parti`);
                this.render();
            },

            hireDriver(driverIndex) {
                const driver = this.drivers[driverIndex];
                if (!driver.unlocked) return;

                if (this.currentDriver) {
                    alert('Hai giÃ  un pilota! Licenzialo prima.');
                    return;
                }

                if (this.canAfford({ money: driver.cost })) {
                    this.spendResources({ money: driver.cost });
                    this.currentDriver = driver;
                    this.showUnlockNotification(`ğŸ‘¤ Assunto: ${driver.name}!`);
                    this.render();
                } else {
                    alert('Fondi insufficienti!');
                }
            },

            fireDriver() {
                if (!confirm('Sei sicuro di voler licenziare il tuo pilota?')) return;
                this.currentDriver = null;
                this.render();
            },

            activateSponsor(sponsorIndex) {
                const sponsor = this.sponsors[sponsorIndex];
                if (!sponsor.unlocked) return;

                // Se giÃ  attivo, disattiva
                if (this.currentSponsor && this.currentSponsor.name === sponsor.name) {
                    this.currentSponsor = null;
                    this.sponsorRacesLeft = 0;
                } else {
                    // Attiva nuovo sponsor con 20 gare
                    this.currentSponsor = sponsor;
                    this.sponsorRacesLeft = 20;
                    this.showUnlockNotification(`ğŸ¢ Sponsor attivato: ${sponsor.name} (20 gare)`);
                }
                this.render();
            },

            // Funzione chiamata dopo ogni gara per decrementare sponsor
            decrementSponsorRaces() {
                if (this.currentSponsor && this.sponsorRacesLeft > 0) {
                    this.sponsorRacesLeft--;
                    
                    if (this.sponsorRacesLeft === 5) {
                        this.showUnlockNotification(`âš ï¸ Contratto sponsor in scadenza: ${this.sponsorRacesLeft} gare rimaste`);
                    }
                    
                    if (this.sponsorRacesLeft === 0) {
                        this.showUnlockNotification(`ğŸ’¼ Contratto sponsor scaduto: ${this.currentSponsor.name}`);
                        this.currentSponsor = null;
                    }
                }
            },

            researchTech(techId) {
                const tech = this.technologies.find(t => t.id === techId);
                if (!tech || tech.researched) return;

                if (tech.requires) {
                    const hasRequirements = tech.requires.every(reqId => {
                        const reqTech = this.technologies.find(t => t.id === reqId);
                        return reqTech && reqTech.researched;
                    });
                    
                    if (!hasRequirements) {
                        alert('Devi prima ricercare le tecnologie prerequisite!');
                        return;
                    }
                }

                if (this.canAfford(tech.cost)) {
                    this.spendResources(tech.cost);
                    tech.researched = true;
                    this.showUnlockNotification(`ğŸ”¬ Ricercata: ${tech.name}!`);
                    this.render();
                } else {
                    alert('Risorse insufficienti!');
                }
            },

            upgradeCar(carIndex, stat) {
                const car = this.ownedCars[carIndex];
                if (!car) return;

                const cost = {
                    money: 500 * (car.upgrades[stat] + 1),
                    parts: 50 * (car.upgrades[stat] + 1)
                };

                if (this.canAfford(cost)) {
                    this.spendResources(cost);
                    car.upgrades[stat]++;
                    this.render();
                } else {
                    alert('Risorse insufficienti!');
                }
            },

            repairCar(carIndex, useParts) {
                const car = this.ownedCars[carIndex];
                if (!car || car.condition >= 100) return;

                const damage = 100 - car.condition;
                let cost;
                
                if (useParts) {
                    cost = { parts: Math.ceil(damage * 2) };
                } else {
                    cost = { money: Math.ceil(damage * 50) };
                }

                let discount = 0;
                if (this.currentDriver && this.currentDriver.bonus.type === 'repair') {
                    discount = Math.abs(this.currentDriver.bonus.value);
                }
                if (this.currentSponsor && this.currentSponsor.bonus.type === 'repair') {
                    discount += Math.abs(this.currentSponsor.bonus.value);
                }
                this.technologies.forEach(tech => {
                    if (tech.researched && tech.bonus.type === 'repair') {
                        discount += Math.abs(tech.bonus.value);
                    }
                });

                Object.keys(cost).forEach(key => {
                    cost[key] = Math.ceil(cost[key] * (1 - discount));
                });

                if (this.canAfford(cost)) {
                    this.spendResources(cost);
                    car.condition = 100;
                    document.getElementById('repairModal').classList.remove('active');
                    this.render();
                } else {
                    alert('Risorse insufficienti!');
                }
            },

            getCarPower(car) {
                let power = 0;
                Object.keys(car.stats).forEach(stat => {
                    let statValue = car.stats[stat] + (car.upgrades[stat] * 10);
                    
                    this.technologies.forEach(tech => {
                        if (tech.researched) {
                            if (tech.bonus.stat === stat) {
                                statValue += tech.bonus.value;
                            } else if (tech.bonus.type === 'allStats') {
                                statValue += tech.bonus.value;
                            }
                        }
                    });
                    
                    power += statValue;
                });
                
                power = power * (car.condition / 100);
                
                return power;
            },

            startRace() {
                const now = Date.now();
                if (now - this.races.lastRaceTime < this.races.cooldown) {
                    const secondsLeft = Math.ceil((this.races.cooldown - (now - this.races.lastRaceTime)) / 1000);
                    alert(`Aspetta ${secondsLeft} secondi prima di iniziare un'altra gara!`);
                    return;
                }

                if (this.ownedCars.length === 0) {
                    alert('Devi prima comprare un\'auto dal concessionario!');
                    return;
                }

                const car = this.ownedCars[this.selectedCarIndex];
                if (car.condition < 30) {
                    alert('Auto troppo danneggiata! Riparala prima di gareggiare.');
                    return;
                }

                const energyCost = 20 - (this.currentDriver && this.currentDriver.bonus.type === 'energy' ? Math.abs(this.currentDriver.bonus.value) : 0);

                if (this.resources.energy.value < energyCost) {
                    alert('Team troppo stanco! Aspetta che l\'energia si ricarichi.');
                    return;
                }

                this.resources.energy.value -= energyCost;

                const carPower = this.getCarPower(car);
                
                let difficultyFactor = 0.85;
                
                if (this.races.completed > 0) {
                    const winRate = this.races.wins / this.races.completed;
                    
                    if (winRate > 0.7) {
                        difficultyFactor = 0.95 + Math.random() * 0.15;
                    } else if (winRate > 0.5) {
                        difficultyFactor = 0.85 + Math.random() * 0.2;
                    } else if (winRate > 0.3) {
                        difficultyFactor = 0.75 + Math.random() * 0.2;
                    } else {
                        difficultyFactor = 0.65 + Math.random() * 0.2;
                    }
                }
                
                const opponentBasePower = carPower * difficultyFactor;
                
                const statDistribution = [
                    0.20 + Math.random() * 0.15,
                    0.15 + Math.random() * 0.15,
                    0.20 + Math.random() * 0.15,
                    0.15 + Math.random() * 0.15
                ];
                
                const sum = statDistribution.reduce((a, b) => a + b, 0);
                const normalized = statDistribution.map(v => v / sum);
                
                const opponent = {
                    name: this.getRandomOpponentName(),
                    stats: {
                        engine: Math.floor(opponentBasePower * normalized[0]),
                        body: Math.floor(opponentBasePower * normalized[1]),
                        electronics: Math.floor(opponentBasePower * normalized[2]),
                        aero: Math.floor(opponentBasePower * normalized[3])
                    }
                };
                
                const opponentPower = Object.values(opponent.stats).reduce((a, b) => a + b, 0);
                const win = carPower > opponentPower;

                let rewards = {};
                
                if (win) {
                    this.races.wins++;
                    
                    const difficultyBonus = Math.max(1, opponentPower / carPower);
                    
                    rewards = {
                        money: Math.floor((Math.random() * 500 + 300) * difficultyBonus),
                        reputation: Math.floor((Math.random() * 15 + 5) * difficultyBonus),
                        parts: Math.floor((Math.random() * 20 + 10) * difficultyBonus)
                    };

                    if (this.currentDriver) {
                        if (this.currentDriver.bonus.type === 'money') {
                            rewards.money = Math.floor(rewards.money * (1 + this.currentDriver.bonus.value));
                        } else if (this.currentDriver.bonus.type === 'reputation') {
                            rewards.reputation = Math.floor(rewards.reputation * (1 + this.currentDriver.bonus.value));
                        } else if (this.currentDriver.bonus.type === 'winBonus') {
                            Object.keys(rewards).forEach(key => {
                                rewards[key] = Math.floor(rewards[key] * (1 + this.currentDriver.bonus.value));
                            });
                        }
                    }

                    if (this.currentSponsor) {
                        if (this.currentSponsor.bonus.type === 'money') {
                            rewards.money = Math.floor(rewards.money * (1 + this.currentSponsor.bonus.value));
                        } else if (this.currentSponsor.bonus.type === 'reputation') {
                            rewards.reputation = Math.floor(rewards.reputation * (1 + this.currentSponsor.bonus.value));
                        } else if (this.currentSponsor.bonus.type === 'parts') {
                            rewards.parts = Math.floor(rewards.parts * (1 + this.currentSponsor.bonus.value));
                        } else if (this.currentSponsor.bonus.type === 'winBonus') {
                            Object.keys(rewards).forEach(key => {
                                rewards[key] = Math.floor(rewards[key] * (1 + this.currentSponsor.bonus.value));
                            });
                        } else if (this.currentSponsor.bonus.type === 'all') {
                            Object.keys(rewards).forEach(key => {
                                rewards[key] = Math.floor(rewards[key] * (1 + this.currentSponsor.bonus.value));
                            });
                        }
                    }
                    
                    Object.keys(rewards).forEach(key => {
                        if (this.resources[key]) {
                            this.resources[key].value = Math.min(
                                this.resources[key].value + rewards[key],
                                this.resources[key].max
                            );
                        }
                    });
                }

                this.races.completed++;
                this.races.lastRaceTime = now;
                
                // Decrementa contratto sponsor
                this.decrementSponsorRaces();
                
                this.raceHistory.unshift({
                    date: new Date().toLocaleString('it-IT'),
                    type: 'Stradale',
                    playerCar: car.name,
                    playerPower: Math.floor(carPower),
                    opponentName: opponent.name,
                    opponentPower: Math.floor(opponentPower),
                    win: win,
                    rewards: win ? rewards : null
                });
                
                if (this.raceHistory.length > 50) {
                    this.raceHistory = this.raceHistory.slice(0, 50);
                }
                
                this.showRaceSummary(win, car, carPower, opponent, opponentPower, rewards, 0, false);
                this.render();
            },

            startChampionship() {
                if (this.championship.active) {
                    alert('Campionato giÃ  in corso!');
                    return;
                }

                if (!this.canAfford({ money: this.championship.entryFee })) {
                    alert('Fondi insufficienti per l\'iscrizione!');
                    return;
                }

                if (this.ownedCars.length === 0) {
                    alert('Serve un\'auto per partecipare!');
                    return;
                }

                const car = this.ownedCars[this.selectedCarIndex];
                if (car.condition < 30) {
                    alert('Auto troppo danneggiata!');
                    return;
                }

                this.spendResources({ money: this.championship.entryFee });
                this.championship.active = true;
                this.championship.currentRace = 0;
                this.championship.wins = 0;
                this.championship.results = [];
                
                this.render();
            },

            runChampionshipRace() {
                if (!this.championship.active) return;

                const car = this.ownedCars[this.selectedCarIndex];
                
                const energyCost = 20 - (this.currentDriver && this.currentDriver.bonus.type === 'energy' ? Math.abs(this.currentDriver.bonus.value) : 0);
                
                if (this.resources.energy.value < energyCost) {
                    alert('Energia insufficiente!');
                    return;
                }

                this.resources.energy.value -= energyCost;

                const carPower = this.getCarPower(car);
                const difficultyFactor = 0.9 + (this.championship.currentRace * 0.05);
                const opponentBasePower = carPower * difficultyFactor;
                
                const statDistribution = [
                    0.20 + Math.random() * 0.15,
                    0.15 + Math.random() * 0.15,
                    0.20 + Math.random() * 0.15,
                    0.15 + Math.random() * 0.15
                ];
                
                const sum = statDistribution.reduce((a, b) => a + b, 0);
                const normalized = statDistribution.map(v => v / sum);
                
                const opponent = {
                    name: this.getRandomOpponentName(),
                    stats: {
                        engine: Math.floor(opponentBasePower * normalized[0]),
                        body: Math.floor(opponentBasePower * normalized[1]),
                        electronics: Math.floor(opponentBasePower * normalized[2]),
                        aero: Math.floor(opponentBasePower * normalized[3])
                    }
                };
                
                const opponentPower = Object.values(opponent.stats).reduce((a, b) => a + b, 0);
                const win = carPower > opponentPower;

                const damage = Math.floor(Math.random() * 15 + 10);
                car.condition = Math.max(0, car.condition - damage);

                let rewards = {};
                if (win) {
                    this.championship.wins++;
                    rewards = {
                        money: Math.floor(500 + (this.championship.currentRace * 200)),
                        reputation: Math.floor(20 + (this.championship.currentRace * 5)),
                        parts: Math.floor(30 + (this.championship.currentRace * 10))
                    };
                    
                    Object.keys(rewards).forEach(key => {
                        if (this.resources[key]) {
                            this.resources[key].value += rewards[key];
                        }
                    });
                }

                this.championship.results.push({ win, opponent: opponent.name, rewards, damage });
                this.championship.currentRace++;
                
                // Decrementa contratto sponsor
                this.decrementSponsorRaces();

                this.raceHistory.unshift({
                    date: new Date().toLocaleString('it-IT'),
                    type: 'Campionato',
                    playerCar: car.name,
                    playerPower: Math.floor(carPower),
                    opponentName: opponent.name,
                    opponentPower: Math.floor(opponentPower),
                    win: win,
                    rewards: win ? rewards : null,
                    damage: damage
                });
                
                if (this.raceHistory.length > 50) {
                    this.raceHistory = this.raceHistory.slice(0, 50);
                }

                if (this.championship.currentRace >= this.championship.totalRaces) {
                    if (this.championship.wins >= 3) {
                        this.resources.money.value += this.championship.prizePool;
                        rewards.championshipBonus = this.championship.prizePool;
                    }
                }

                this.showRaceSummary(win, car, carPower, opponent, opponentPower, rewards, damage, true);
                this.render();
            },

            abandonChampionship() {
                if (!confirm('Sei sicuro di voler abbandonare il campionato?')) return;
                
                this.championship.active = false;
                this.championship.currentRace = 0;
                this.championship.wins = 0;
                this.championship.results = [];
                this.render();
            },

    // ===== FIX BUG 1 & 3: "won" â†’ "win", rimossa riga "modal.classList.add('active')" =====
    showRaceSummary(win, playerCar, playerPower, opponent, opponentPower, rewards, damage, isChampionship) {
        const modalContent = document.querySelector('#raceModal .modal-content');
        if (win) {
            modalContent.classList.add('win');
        } else {
            modalContent.classList.remove('win');
        }
        document.getElementById('raceModal').classList.add('active');

        const result = document.getElementById('raceResult');
        const comparison = document.getElementById('raceComparison');
        const rewardsDiv = document.getElementById('raceRewards');
        const damageSection = document.getElementById('damageSection');

        result.textContent = win ? 'ğŸ† VITTORIA!' : 'ğŸ’¥ SCONFITTA!';
        result.className = `modal-title ${win ? 'win' : 'lose'}`;

        // Scelta casuale immagine (1-10) e storia
        const imageNum = Math.floor(Math.random() * 10) + 1;
        const imagePath = win ? `victory_${imageNum}.jpg` : `defeat_${imageNum}.jpg`;
        const stories = win ? this.victoryStories : this.defeatStories;
        const randomStory = stories[Math.floor(Math.random() * stories.length)] || (win ? "Ottima gara!" : "Riprova!");

        // Calcola stat con tecnologie
        const getStatWithTech = (baseStat, upgrades, statName) => {
            let value = baseStat + (upgrades * 10);
            this.technologies.forEach(tech => {
                if (tech.researched) {
                    if (tech.bonus.stat === statName) {
                        value += tech.bonus.value;
                    } else if (tech.bonus.type === 'allStats') {
                        value += tech.bonus.value;
                    }
                }
            });
            return value;
        };

        // COSTRUZIONE HTML - STILE PVP CENTRATO
        comparison.innerHTML = `
            <!-- Immagine vittoria/sconfitta -->
            <div style="grid-column: 1 / -1; margin-bottom: 15px;">
                <img src="${imagePath}" 
                     alt="${win ? 'Vittoria' : 'Sconfitta'}" 
                     onerror="this.style.display='none';"
                     style="width: 100%; height: 180px; object-fit: cover; border-radius: 10px; margin-bottom: 10px;">
                <div style="font-size: 0.9rem; line-height: 1.4; color: var(--text-secondary); text-align: center; font-style: italic; padding: 0 15px;">
                    "${randomStory}"
                </div>
            </div>
            
            <div style="text-align: center; margin-bottom: 15px;">
                <h3 style="color: var(--accent-cyan); margin-bottom: 10px;">ğŸï¸ TUA AUTO</h3>
                <p style="font-size: 1.2rem; font-weight: 700;">${playerCar.name}</p>
                <p style="color: var(--accent-yellow); font-size: 1.5rem; font-weight: 900;">${Math.floor(playerPower)} HP</p>
            </div>
            <div style="text-align: center;">
                <h3 style="color: var(--accent-red); margin-bottom: 10px;">ğŸï¸ AVVERSARIO</h3>
                <p style="font-size: 1.2rem; font-weight: 700;">${opponent.name}</p>
                <p style="color: var(--accent-yellow); font-size: 1.5rem; font-weight: 900;">${Math.floor(opponentPower)} HP</p>
            </div>
        `;

        // Rewards - STILE PVP
        if (win && rewards) {
            rewardsDiv.style.display = 'block';
            rewardsDiv.innerHTML = `
                <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="text-align: center; margin-bottom: 15px; color: var(--accent-green);">ğŸ† BOTTINO</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                        ${rewards.money ? `
                            <div>
                                <div style="font-size: 0.85rem; color: #a0a0a0;">Denaro</div>
                                <div style="font-size: 1.5rem; font-weight: 900; color: var(--accent-green);">+${rewards.money}</div>
                            </div>
                        ` : ''}
                        ${rewards.reputation ? `
                            <div>
                                <div style="font-size: 0.85rem; color: #a0a0a0;">Reputazione</div>
                                <div style="font-size: 1.5rem; font-weight: 900; color: var(--accent-green);">+${rewards.reputation}</div>
                            </div>
                        ` : ''}
                        ${rewards.parts ? `
                            <div>
                                <div style="font-size: 0.85rem; color: #a0a0a0;">Parti</div>
                                <div style="font-size: 1.5rem; font-weight: 900; color: var(--accent-green);">+${rewards.parts}</div>
                            </div>
                        ` : ''}
                        ${rewards.championshipBonus ? `
                            <div>
                                <div style="font-size: 0.85rem; color: #a0a0a0;">Bonus Campionato</div>
                                <div style="font-size: 1.5rem; font-weight: 900; color: var(--accent-green);">+${rewards.championshipBonus}â‚¬</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        } else {
            rewardsDiv.style.display = 'none';
        }

        if (isChampionship && damage > 0) {
            damageSection.innerHTML = `
                <div class="damage-indicator" style="margin-top: 15px;">
                    <div>âš ï¸ Danni Subiti</div>
                    <div class="damage-value">-${damage}% Condizione</div>
                    <div style="margin-top: 5px; font-size: 0.85rem;">Condizione attuale: ${playerCar.condition.toFixed(0)}%</div>
                </div>
            `;
        } else {
            damageSection.innerHTML = '';
        }

        if (isChampionship && this.championship.currentRace >= this.championship.totalRaces) {
            setTimeout(() => {
                this.championship.active = false;
                if (this.championship.wins >= 3) {
                    this.showUnlockNotification(`ğŸ† HAI VINTO IL CAMPIONATO! +${this.championship.prizePool}â‚¬`);
                } else {
                    this.showUnlockNotification('âŒ Campionato fallito. Ritenta!');
                }
            }, 100);
        }
    },

            closeRaceModal() {
        document.getElementById('raceModal').classList.remove('active');
        document.querySelector('#raceModal .modal-content').classList.remove('win');
    },

            getRandomOpponentName() {
                const names = [
                    'Street Racer', 'Pro Driver', 'Speed Demon', 'Track Master', 'Drift King',
                    'Turbo Ace', 'Racing Legend', 'Circuit Pro', 'Velocity Hunter', 'Asphalt Warrior'
                ];
                return names[Math.floor(Math.random() * names.length)];
            },

            checkUnlocks() {
                Object.keys(this.workshop).forEach(key => {
                    const section = this.workshop[key];
                    if (!section.unlocked && section.unlockCondition) {
                        const canUnlock = Object.keys(section.unlockCondition).every(res =>
                            this.resources[res].value >= section.unlockCondition[res]
                        );
                        
                        if (canUnlock) {
                            section.unlocked = true;
                            this.showUnlockNotification(`ğŸ”“ SBLOCCATO: ${section.name}!`);
                        }
                    }
                });

                this.availableCars.forEach(car => {
                    if (!car.unlocked && car.unlockCondition) {
                        const canUnlock = Object.keys(car.unlockCondition).every(res =>
                            this.resources[res].value >= car.unlockCondition[res]
                        );
                        
                        if (canUnlock) {
                            car.unlocked = true;
                            this.showUnlockNotification(`ğŸ”“ DISPONIBILE: ${car.name}!`);
                        }
                    }
                });

                this.drivers.forEach(driver => {
                    if (!driver.unlocked && driver.unlockCondition) {
                        const canUnlock = Object.keys(driver.unlockCondition).every(res =>
                            this.resources[res].value >= driver.unlockCondition[res]
                        );
                        
                        if (canUnlock) {
                            driver.unlocked = true;
                            this.showUnlockNotification(`ğŸ”“ PILOTA: ${driver.name}!`);
                        }
                    }
                });

                this.sponsors.forEach(sponsor => {
                    if (!sponsor.unlocked && this.races.wins >= sponsor.requirement) {
                        sponsor.unlocked = true;
                        this.showUnlockNotification(`ğŸ”“ SPONSOR: ${sponsor.name}!`);
                    }
                });
            },

            showUnlockNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'unlock-notification';
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            },

            render() {
                this.renderResources();
                this.checkUnlocks();
                
                if (this.currentPage === 'workshop') {
                    this.renderWorkshop();
                } else if (this.currentPage === 'garage') {
                    this.renderOwnedCars();
                    this.renderTeam();
                } else if (this.currentPage === 'dealer') {
                    this.renderAvailableCars();
                } else if (this.currentPage === 'tech') {
                    this.renderTech();
                } else if (this.currentPage === 'race') {
                    this.renderRace();
                    try {
                        this.renderHistoryInline();
                    } catch (error) {
                        console.error('Errore renderHistoryInline:', error);
                    }
                } else if (this.currentPage === 'leaderboard') {
                    this.renderLeaderboard();
                }
            },

            renderResources() {
                const container = document.getElementById('resources');
                container.innerHTML = Object.keys(this.resources).map(key => {
                    const res = this.resources[key];
                    const rateText = res.rate > 0 ? `+${res.rate.toFixed(0)}/h` : '';
                    return `
                        <div class="resource-card">
                            <div class="resource-icon">${res.icon}</div>
                            <div class="resource-info">
                                <div class="resource-value">${Math.floor(res.value).toLocaleString()}</div>
                                <div class="resource-rate">${rateText}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderWorkshop() {
                const container = document.getElementById('workshop');
                
                // âœ… Memorizza quale sezione era aperta
                let activeSection = 0;
                const activeDetail = document.querySelector('.workshop-detail[style*="display: block"]');
                if (activeDetail) {
                    const activeSections = document.querySelectorAll('.workshop-detail');
                    activeSections.forEach((el, idx) => {
                        if (el.style.display === 'block') activeSection = idx;
                    });
                }
                
                // Calcola stats totali
                const totalProduction = Object.keys(this.workshop).reduce((acc, key) => {
                    const section = this.workshop[key];
                    if (section.production && section.level > 0) {
                        Object.keys(section.production).forEach(res => {
                            acc[res] = (acc[res] || 0) + (section.production[res] * section.level);
                        });
                    }
                    return acc;
                }, {});
                
                const workshopSections = Object.keys(this.workshop);
                
                // âœ… Calcola quale immagine mostrare in base alla sezione attiva
                const imageMap = {
                    'engine': 'engine.jpg',
                    'electronics': 'electronics.jpg',
                    'body': 'body.jpg',
                    'aerodynamics': 'aero.jpg'
                };
                const currentSectionKey = workshopSections[activeSection] || 'engine';
                const initialImage = imageMap[currentSectionKey] || 'engine.jpg';
                
                container.innerHTML = `
                    <div class="page-container">
                        <div class="section-layout">
                            <!-- Menu laterale SX -->
                            <div class="side-menu">
                                ${workshopSections.map((key, idx) => {
                                    const section = this.workshop[key];
                                    // Mappa immagini per reparto
                                    const imageMap = {
                                        'engine': 'engine.jpg',
                                        'electronics': 'electronics.jpg',
                                        'body': 'body.jpg',
                                        'aerodynamics': 'aero.jpg'
                                    };
                                    const imageName = imageMap[key] || 'workshop.jpg';
                                    
                                    return `
                                        <button class="side-menu-btn ${idx === activeSection ? 'active' : ''}" 
                                                onclick="
                                                    document.querySelectorAll('.workshop-detail').forEach(d => d.style.display='none'); 
                                                    document.getElementById('workshop-${key}').style.display='block';
                                                    document.querySelectorAll('.side-menu-btn').forEach(b => b.classList.remove('active'));
                                                    this.classList.add('active');
                                                    
                                                    // Cambia immagine
                                                    const img = document.getElementById('workshop-image');
                                                    img.src = 'images/sections/${imageName}';
                                                    img.alt = '${section.name}';
                                                ">
                                            ${section.icon}<br>${section.name.split(' ').pop()}
                                        </button>
                                    `;
                                }).join('')}
                            </div>

                            <!-- Immagine centrale -->
                            <div class="section-image-container">
                                <img id="workshop-image"
                                     src="images/sections/${initialImage}" 
                                     class="section-image" 
                                     alt="Officina"
                                     onerror="console.error('âŒ Immagine non trovata:', this.src); this.style.display='none'; this.parentElement.style.background='linear-gradient(135deg, #1a1a1a, #0a0a0a)'; this.parentElement.innerHTML='<div style=text-align:center;padding-top:100px><div style=font-size:4rem>ğŸ”§</div></div>'">
                            </div>

                            <!-- Stats laterale DX -->
                            <div class="side-stats">
                                <div class="stat-box">
                                    <div class="stat-label">LIVELLI TOTALI</div>
                                    <div class="stat-value">${workshopSections.reduce((sum, k) => sum + this.workshop[k].level, 0)}</div>
                                </div>
                                ${Object.keys(totalProduction).length > 0 ? `
                                    <div class="stat-box">
                                        <div class="stat-label">PRODUZIONE/H</div>
                                        <div class="stat-value" style="font-size: 0.9rem;">
                                            ${Object.keys(totalProduction).map(res => 
                                                `${this.resources[res].icon}${totalProduction[res].toFixed(0)}`
                                            ).join('<br>')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Dettagli sezioni -->
                        ${workshopSections.map((key, idx) => {
                            const section = this.workshop[key];
                            const cost = this.getUpgradeCost(section);
                            const canUpgrade = this.canAfford(cost) && section.level < section.maxLevel;
                            const locked = !section.unlocked;

                            let production = '';
                            if (section.production && section.level > 0) {
                                production = Object.keys(section.production).map(res => {
                                    const icon = this.resources[res]?.icon || '';
                                    const amount = section.production[res] * section.level;
                                    return `${icon} +${amount.toFixed(0)}/h`;
                                }).join(' ');
                            }

                            let nextLevelBonus = '';
                            if (section.level < section.maxLevel) {
                                if (section.production) {
                                    nextLevelBonus = Object.keys(section.production).map(res => {
                                        const icon = this.resources[res]?.icon || '';
                                        const amount = section.production[res];
                                        return `${icon}+${amount.toFixed(0)}/h`;
                                    }).join(' ');
                                } else if (section.oneTimeBonus && section.oneTimeBonus.reputation) {
                                    nextLevelBonus = `â­+${section.oneTimeBonus.reputation} reputazione`;
                                } else if (section.reputationBonus) {
                                    nextLevelBonus = `â­+${section.reputationBonus} reputazione`;
                                }
                            }

                            return `
                                <div class="workshop-detail" id="workshop-${key}" style="display: ${idx === activeSection ? 'block' : 'none'}; margin-top: 12px;">
                                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border: 2px solid var(--accent-cyan);">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                            <div>
                                                <h3 style="font-family: Orbitron; font-size: 1.3rem; color: var(--accent-cyan); margin-bottom: 4px;">
                                                    ${section.icon} ${section.name}
                                                </h3>
                                                <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-yellow);">
                                                    Livello ${section.level}/${section.maxLevel}
                                                </div>
                                            </div>
                                            ${!locked ? `
                                                <button 
                                                    class="upgrade-btn-compact" 
                                                    onclick="game.upgradeWorkshop('${key}')"
                                                    style="min-width: 130px; height: 45px;"
                                                    ${!canUpgrade ? 'disabled' : ''}>
                                                    ${section.level < section.maxLevel ? 'â¬†ï¸ UPGRADE' : 'âœ“ MAX'}
                                                </button>
                                            ` : ''}
                                        </div>

                                        ${section.level > 0 && production ? `
                                            <div style="background: rgba(0,255,136,0.1); padding: 12px; border-radius: 6px; margin-bottom: 12px; border: 1px solid var(--accent-green);">
                                                <strong style="color: var(--accent-green);">ğŸ“Š Produzione:</strong> ${production}
                                            </div>
                                        ` : ''}

                                        ${!locked && section.level < section.maxLevel ? `
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                                <div style="background: rgba(0,217,255,0.1); padding: 10px; border-radius: 6px; border: 1px solid var(--accent-cyan);">
                                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Prossimo livello</div>
                                                    <div style="font-weight: 700; color: var(--accent-cyan); font-size: 0.85rem; white-space: nowrap;">${nextLevelBonus || 'Bonus'}</div>
                                                </div>
                                                <div style="background: rgba(255,215,0,0.1); padding: 10px; border-radius: 6px; border: 1px solid var(--accent-yellow);">
                                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Costo</div>
                                                    <div style="font-weight: 700; color: var(--accent-yellow); font-size: 0.85rem; white-space: nowrap;">
                                                        ${Object.keys(cost).map(res => 
                                                            `${this.resources[res].icon}${cost[res]}`
                                                        ).join(' ')}
                                                    </div>
                                                </div>
                                            </div>
                                        ` : locked ? `
                                            <div style="text-align: center; padding: 15px; background: rgba(255,51,51,0.1); border-radius: 6px; border: 1px solid var(--accent-red);">
                                                <div style="font-size: 1.1rem; margin-bottom: 8px;">ğŸ”’ BLOCCATO</div>
                                                <div style="color: var(--text-secondary); font-size: 0.85rem;">
                                                    Richiede: ${Object.keys(section.unlockCondition).map(res =>
                                                        `${this.resources[res].icon} ${section.unlockCondition[res]}`
                                                    ).join(', ')}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },

            renderAvailableCars() {
                const container = document.getElementById('dealerCars');
                container.innerHTML = this.availableCars.map((car, index) => {
                    const locked = !car.unlocked;
                    const owned = this.ownedCars.some(c => c.name === car.name);
                    const canBuy = this.canAfford(car.price) && !owned;
                    const power = Object.values(car.stats).reduce((a, b) => a + b, 0);

                    return `
                        <div class="car-card ${locked ? 'locked' : ''}">
                            ${car.image ? `
                                <div style="width: 100%; height: 150px; overflow: hidden; border-radius: 10px; margin-bottom: 15px;">
                                    <img src="${car.image}" alt="${car.name}" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                            ` : ''}
                            <div class="car-header">
                                <div class="car-name">${car.name}</div>
                            </div>
                            ${!locked ? `
                                <div style="text-align: center; margin: 15px 0;">
                                    <div style="font-size: 2rem; color: var(--accent-yellow); margin-bottom: 10px;">
                                        ${power} HP
                                    </div>
                                    <div style="font-size: 1.2rem; color: var(--accent-yellow);">
                                        ${Object.keys(car.price).map(res =>
                                            `${this.resources[res].icon} ${car.price[res]}`
                                        ).join(' â€¢ ')}
                                    </div>
                                </div>
                                <div style="padding: 0 5px;">
                                    <div class="car-stats">
                                        ${Object.keys(car.stats).map(stat => {
                                            const value = car.stats[stat];
                                            const percentage = (value / 100) * 100;
                                            return `
                                                <div style="margin-bottom: 10px;">
                                                    <div class="stat-label">
                                                        <span>${stat.charAt(0).toUpperCase() + stat.slice(1)}</span>
                                                        <span>${value}</span>
                                                    </div>
                                                    <div class="progress-bar">
                                                        <div class="progress-fill" style="width: ${percentage}%"></div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                                <button 
                                    class="btn btn-cyan" 
                                    onclick="game.buyCar(${index})"
                                    ${!canBuy || owned ? 'disabled' : ''}>
                                    ${owned ? 'âœ“ GIÃ€ POSSEDUTA' : 'ACQUISTA'}
                                </button>
                            ` : `
                                <div style="padding: 60px 20px; text-align: center; color: var(--text-secondary);">
                                    <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ”’</div>
                                    <div>
                                        Richiede: ${Object.keys(car.unlockCondition).map(res =>
                                            `${this.resources[res].icon} ${car.unlockCondition[res]}`
                                        ).join(', ')}
                                    </div>
                                </div>
                            `}
                        </div>
                    `;
                }).join('');
            },

            renderOwnedCars() {
                const container = document.getElementById('myGarage');
                
                if (this.ownedCars.length === 0) {
                    container.innerHTML = `
                        <div class="empty-garage">
                            <div class="empty-garage-icon">ğŸï¸</div>
                            <div>Nessuna auto nel garage</div>
                            <div style="margin-top: 10px; font-size: 1rem;">Vai al Concessionario!</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="dealer-grid">
                        ${this.ownedCars.map((car, index) => {
                            const power = this.getCarPower(car);
                            const needsRepair = car.condition < 100;

                            return `
                                <div class="car-card ${needsRepair ? 'damaged' : ''}">
                                    ${car.image ? `
                                        <div style="width: 100%; height: 140px; overflow: hidden; border-radius: 10px; margin-bottom: 12px;">
                                            <img src="${car.image}" alt="${car.name}" style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>
                                    ` : ''}
                                    
                                    <div style="text-align: center; margin-bottom: 10px;">
                                        <div class="car-name" style="font-size: 1.2rem; margin-bottom: 3px;">${car.name}</div>
                                        <div style="font-size: 1.3rem; color: var(--accent-yellow);">
                                            ${power.toFixed(0)} HP
                                        </div>
                                        <div style="font-size: 0.8rem; margin-top: 3px; color: ${car.condition < 50 ? 'var(--accent-red)' : 'var(--accent-green)'};">
                                            ${needsRepair ? 'âš ï¸' : 'âœ“'} ${car.condition.toFixed(0)}%
                                        </div>
                                    </div>

                                    ${Object.keys(car.stats).map(stat => {
                                        const baseValue = car.stats[stat];
                                        const upgradeValue = car.upgrades[stat] * 10;
                                        
                                        // Calcola bonus tecnologie per questa stat
                                        let techBonus = 0;
                                        this.technologies.forEach(tech => {
                                            if (tech.researched) {
                                                if (tech.bonus.stat === stat) {
                                                    techBonus += tech.bonus.value;
                                                } else if (tech.bonus.type === 'allStats') {
                                                    techBonus += tech.bonus.value;
                                                }
                                            }
                                        });
                                        
                                        const totalValue = baseValue + upgradeValue + techBonus;
                                        const maxValue = 150;
                                        const percentage = (totalValue / maxValue) * 100;
                                        const cost = {
                                            money: 500 * (car.upgrades[stat] + 1),
                                            parts: 50 * (car.upgrades[stat] + 1)
                                        };
                                        const canUpgrade = this.canAfford(cost);

                                        return `
                                            <div style="margin-bottom: 6px;">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">
                                                    <span style="font-size: 0.8rem; text-transform: capitalize;">${stat}</span>
                                                    <div style="display: flex; align-items: center; gap: 6px;">
                                                        <span style="font-size: 0.8rem; font-weight: 600;">${totalValue}</span>
                                                        <button 
                                                            onclick="game.upgradeCar(${index}, '${stat}')"
                                                            style="background: ${canUpgrade ? 'linear-gradient(135deg, var(--accent-green), #00cc66)' : '#444'}; 
                                                                   border: none; 
                                                                   color: ${canUpgrade ? 'white' : '#666'}; 
                                                                   width: 24px; 
                                                                   height: 24px; 
                                                                   border-radius: 4px; 
                                                                   cursor: ${canUpgrade ? 'pointer' : 'not-allowed'}; 
                                                                   font-weight: 700; 
                                                                   font-size: 1rem;
                                                                   display: flex;
                                                                   align-items: center;
                                                                   justify-content: center;
                                                                   transition: all 0.2s;"
                                                            ${!canUpgrade ? 'disabled' : ''}>
                                                            +
                                                        </button>
                                                    </div>
                                                </div>
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                                                    <div style="font-size: 0.7rem; color: var(--text-secondary);">
                                                        ğŸ’° ${cost.money} â€¢ ğŸ”© ${cost.parts}
                                                    </div>
                                                    <div style="font-size: 0.7rem; color: var(--accent-green);">
                                                        +10
                                                    </div>
                                                </div>
                                                <div class="progress-bar" style="height: 6px; border-radius: 3px;">
                                                    <div class="progress-fill" style="width: ${percentage}%; border-radius: 3px;"></div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}

                                    <div style="display: flex; gap: 5px; margin-top: 10px;">
                                        ${needsRepair ? `
                                            <button class="btn btn-small" onclick="game.showRepairModal(${index})" style="flex: 1; font-size: 0.75rem; padding: 6px;">
                                                ğŸ”§ Ripara
                                            </button>
                                        ` : ''}
                                        <button class="btn btn-small" onclick="game.sellCar(${index})" style="flex: 1; background: #666; font-size: 0.75rem; padding: 6px;">
                                            ğŸ’° Vendi
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },

            renderTech() {
                const container = document.getElementById('techTree');
                container.innerHTML = this.technologies.map(tech => {
                    const researched = tech.researched;
                    const canResearch = this.canAfford(tech.cost);
                    
                    let hasPrerequisites = true;
                    if (tech.requires) {
                        hasPrerequisites = tech.requires.every(reqId => {
                            const reqTech = this.technologies.find(t => t.id === reqId);
                            return reqTech && reqTech.researched;
                        });
                    }

                    let bonusText = '';
                    if (tech.bonus.stat) {
                        bonusText = `+${tech.bonus.value} ${tech.bonus.stat.toUpperCase()}`;
                    } else if (tech.bonus.type === 'allStats') {
                        bonusText = `+${tech.bonus.value} a tutte le stats`;
                    } else if (tech.bonus.type === 'repair') {
                        bonusText = `${(tech.bonus.value * 100).toFixed(0)}% costi riparazione`;
                    }

                    return `
                        <div class="tech-card ${researched ? 'researched' : ''}">
                            <div style="font-size: 3rem; margin-bottom: 10px;">
                                ${tech.icon}
                            </div>
                            <div style="font-family: 'Orbitron'; font-size: 1.2rem; font-weight: 700; margin-bottom: 10px;">
                                ${tech.name}
                            </div>
                            <div style="color: var(--accent-cyan); margin-bottom: 15px; font-size: 1.1rem;">
                                ${bonusText}
                            </div>
                            ${tech.requires && !researched ? `
                                <div style="color: ${hasPrerequisites ? 'var(--accent-green)' : 'var(--accent-red)'}; margin-bottom: 10px; font-size: 0.9rem;">
                                    Richiede: ${tech.requires.map(reqId => {
                                        const reqTech = this.technologies.find(t => t.id === reqId);
                                        return reqTech ? reqTech.name : reqId;
                                    }).join(', ')}
                                </div>
                            ` : ''}
                            ${!researched ? `
                                <div style="margin-bottom: 15px; font-size: 0.9rem; color: var(--text-secondary);">
                                    ${Object.keys(tech.cost).map(res =>
                                        `${this.resources[res] ? this.resources[res].icon : res} ${tech.cost[res]}`
                                    ).join(' â€¢ ')}
                                </div>
                                <button class="btn btn-cyan" onclick="game.researchTech('${tech.id}')" 
                                        ${!canResearch || !hasPrerequisites ? 'disabled' : ''}>
                                    Ricerca
                                </button>
                            ` : `
                                <div style="color: var(--accent-green); font-weight: 700; margin-top: 15px;">
                                    âœ“ RICERCATA
                                </div>
                            `}
                        </div>
                    `;
                }).join('');
            },

            showRepairModal(carIndex) {
                const car = this.ownedCars[carIndex];
                const damage = 100 - car.condition;
                
                const moneyCost = Math.ceil(damage * 50);
                const partsCost = Math.ceil(damage * 2);

                let discount = 0;
                if (this.currentDriver && this.currentDriver.bonus.type === 'repair') {
                    discount += Math.abs(this.currentDriver.bonus.value);
                }
                if (this.currentSponsor && this.currentSponsor.bonus.type === 'repair') {
                    discount += Math.abs(this.currentSponsor.bonus.value);
                }
                this.technologies.forEach(tech => {
                    if (tech.researched && tech.bonus.type === 'repair') {
                        discount += Math.abs(tech.bonus.value);
                    }
                });

                const finalMoney = Math.ceil(moneyCost * (1 - discount));
                const finalParts = Math.ceil(partsCost * (1 - discount));

                document.getElementById('repairContent').innerHTML = `
                    <div style="text-align: center; margin: 20px 0;">
                        <div style="font-size: 1.5rem; margin-bottom: 20px;">
                            ${car.name}
                        </div>
                        <div style="font-size: 1.2rem; color: var(--accent-red); margin-bottom: 20px;">
                            Danno: ${damage.toFixed(1)}%
                        </div>
                        ${discount > 0 ? `
                            <div style="color: var(--accent-green); margin-bottom: 20px;">
                                Sconto Riparazione: -${(discount * 100).toFixed(0)}%
                            </div>
                        ` : ''}
                    </div>
                    <button class="btn" onclick="game.repairCar(${carIndex}, false)">
                        Ripara con Denaro (${finalMoney}â‚¬)
                    </button>
                    <button class="btn" onclick="game.repairCar(${carIndex}, true)">
                        Ripara con Parti (${finalParts} ğŸ”©)
                    </button>
                    <button class="btn" onclick="document.getElementById('repairModal').classList.remove('active')" style="background: #666;">
                        Annulla
                    </button>
                `;

                document.getElementById('repairModal').classList.add('active');
            },

            renderTeam() {
                const driversContainer = document.getElementById('driversSection');
                driversContainer.innerHTML = this.drivers.map((driver, index) => {
                    const locked = !driver.unlocked;
                    // Fix: confronta per nome invece che per reference
                    const isActive = this.currentDriver && this.currentDriver.name === driver.name;
                    const canHire = this.canAfford({ money: driver.cost });

                    let bonusText = '';
                    if (driver.bonus.type === 'energy') {
                        bonusText = `${driver.bonus.value} energia per gara`;
                    } else if (driver.bonus.type === 'money') {
                        bonusText = `+${(driver.bonus.value * 100).toFixed(0)}% denaro gare`;
                    } else if (driver.bonus.type === 'repair') {
                        bonusText = `${(driver.bonus.value * 100).toFixed(0)}% costo riparazione`;
                    } else if (driver.bonus.type === 'reputation') {
                        bonusText = `+${(driver.bonus.value * 100).toFixed(0)}% reputazione`;
                    } else if (driver.bonus.type === 'winBonus') {
                        bonusText = `+${(driver.bonus.value * 100).toFixed(0)}% tutte ricompense`;
                    }

                    return `
                        <div class="team-card ${locked ? 'locked' : ''} ${isActive ? 'active' : ''}">
                            <div style="font-size: 3rem; margin-bottom: 10px;">
                                ${driver.icon}
                            </div>
                            <div style="font-family: 'Orbitron'; font-size: 1.2rem; font-weight: 700; margin-bottom: 10px;">
                                ${driver.name}
                            </div>
                            <div style="color: var(--text-secondary); margin-bottom: 15px;">
                                ${driver.description}
                            </div>
                            ${!locked ? `
                                <div style="color: var(--accent-green); margin-bottom: 15px;">
                                    ${bonusText}
                                </div>
                                ${isActive ? `
                                    <button class="btn" onclick="game.fireDriver()">
                                        Licenzia
                                    </button>
                                ` : `
                                    <button class="btn btn-purple" onclick="game.hireDriver(${index})" ${!canHire || this.currentDriver ? 'disabled' : ''}>
                                        Assumi (${driver.cost}â‚¬)
                                    </button>
                                `}
                            ` : `
                                <div style="color: var(--text-secondary); margin-top: 15px;">
                                    ğŸ”’ ${Object.keys(driver.unlockCondition).map(res =>
                                        `${this.resources[res].icon} ${driver.unlockCondition[res]}`
                                    ).join(', ')}
                                </div>
                            `}
                        </div>
                    `;
                }).join('');

                const sponsorsContainer = document.getElementById('sponsorsSection');
                sponsorsContainer.innerHTML = this.sponsors.map((sponsor, index) => {
                    const locked = !sponsor.unlocked;
                    // Fix: confronta per nome invece che per reference
                    const isActive = this.currentSponsor && this.currentSponsor.name === sponsor.name;

                    let bonusText = '';
                    if (sponsor.bonus.type === 'money') {
                        bonusText = `+${(sponsor.bonus.value * 100).toFixed(0)}% denaro gare`;
                    } else if (sponsor.bonus.type === 'parts') {
                        bonusText = `+${(sponsor.bonus.value * 100).toFixed(0)}% parti gare`;
                    } else if (sponsor.bonus.type === 'reputation') {
                        bonusText = `+${(sponsor.bonus.value * 100).toFixed(0)}% reputazione`;
                    } else if (sponsor.bonus.type === 'energy') {
                        bonusText = `+${sponsor.bonus.value} energia max`;
                    } else if (sponsor.bonus.type === 'winBonus') {
                        bonusText = `+${(sponsor.bonus.value * 100).toFixed(0)}% ricompense vittoria`;
                    } else if (sponsor.bonus.type === 'repair') {
                        bonusText = `${(sponsor.bonus.value * 100).toFixed(0)}% costo riparazione`;
                    } else if (sponsor.bonus.type === 'all') {
                        bonusText = `+${(sponsor.bonus.value * 100).toFixed(0)}% tutte ricompense`;
                    }

                    return `
                        <div class="team-card ${locked ? 'locked' : ''} ${isActive ? 'active' : ''}">
                            <div style="font-size: 3rem; margin-bottom: 10px;">
                                ${sponsor.icon}
                            </div>
                            <div style="font-family: 'Orbitron'; font-size: 1.2rem; font-weight: 700; margin-bottom: 10px;">
                                ${sponsor.name}
                            </div>
                            ${!locked ? `
                                <div style="color: var(--accent-yellow); margin-bottom: 15px;">
                                    ${bonusText}
                                </div>
                                ${isActive && this.sponsorRacesLeft > 0 ? `
                                    <div style="background: rgba(255, 215, 0, 0.2); border: 1px solid var(--accent-yellow); border-radius: 5px; padding: 8px; margin-bottom: 15px; font-size: 0.9rem;">
                                        â³ ${this.sponsorRacesLeft} gare rimaste
                                    </div>
                                ` : ''}
                                <button class="btn btn-success" onclick="game.activateSponsor(${index})">
                                    ${isActive ? 'Disattiva' : 'Attiva (20 gare)'}
                                </button>
                            ` : `
                                <div style="color: var(--text-secondary); margin-top: 15px;">
                                    ğŸ”’ Richiede ${sponsor.requirement} vittorie
                                </div>
                            `}
                        </div>
                    `;
                }).join('');
            },

            renderRace() {
                const selectorContainer = document.getElementById('carSelector');
                if (this.ownedCars.length > 0) {
                    selectorContainer.innerHTML = this.ownedCars.map((car, index) => {
                        const power = this.getCarPower(car);
                        const isActive = index === this.selectedCarIndex;
                        const isDamaged = car.condition < 100;
                        
                        return `
                            <div class="car-select-btn ${isActive ? 'active' : ''} ${isDamaged ? 'damaged' : ''}"
                                 onclick="game.selectedCarIndex = ${index}; game.render();">
                                <div style="font-weight: 700;">${car.name}</div>
                                <div style="font-size: 0.9rem; margin-top: 5px;">${power.toFixed(0)} HP</div>
                                <div style="font-size: 0.8rem; color: ${car.condition < 50 ? 'var(--accent-red)' : 'var(--accent-green)'};">
                                    ${car.condition.toFixed(0)}%
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    selectorContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">Nessuna auto posseduta</div>';
                }

                const container = document.getElementById('raceInfo');
                const now = Date.now();
                const timeUntilNextRace = Math.max(0, this.races.cooldown - (now - this.races.lastRaceTime));
                const secondsLeft = Math.ceil(timeUntilNextRace / 1000);

                const canRace = secondsLeft === 0 && this.ownedCars.length > 0 && this.resources.energy.value >= 20;
                const raceBtn = document.getElementById('raceBtn');
                if (raceBtn) {
                    raceBtn.disabled = !canRace;
                }

                container.innerHTML = `
                    <div class="race-stat">
                        <div class="race-stat-value">${this.races.completed}</div>
                        <div class="race-stat-label">Gare Completate</div>
                    </div>
                    <div class="race-stat">
                        <div class="race-stat-value">${this.races.wins}</div>
                        <div class="race-stat-label">Vittorie</div>
                    </div>
                    <div class="race-stat">
                        <div class="race-stat-value">${this.races.completed > 0 ? Math.round((this.races.wins / this.races.completed) * 100) : 0}%</div>
                        <div class="race-stat-label">Win Rate</div>
                    </div>
                    <div class="race-stat">
                        <div class="race-stat-value">${secondsLeft > 0 ? secondsLeft + 's' : 'âœ“'}</div>
                        <div class="race-stat-label">Prossima Gara</div>
                    </div>
                `;

                const champContainer = document.getElementById('championshipSection');
                if (this.championship.active) {
                    let html = `
                        <div class="championship-progress">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div style="font-family: 'Orbitron'; font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;">
                                    Gara ${this.championship.currentRace + 1} di ${this.championship.totalRaces}
                                </div>
                                <div style="font-size: 1.2rem; color: var(--accent-green);">
                                    Vittorie: ${this.championship.wins}/${this.championship.totalRaces}
                                </div>
                            </div>
                    `;

                    this.championship.results.forEach((result, index) => {
                        html += `
                            <div class="championship-race completed ${result.win ? 'win' : 'lose'}">
                                <span>Gara ${index + 1}</span>
                                <span>${result.win ? 'ğŸ† Vittoria' : 'ğŸ’¥ Sconfitta'} vs ${result.opponent}</span>
                            </div>
                        `;
                    });

                    for (let i = this.championship.results.length; i < this.championship.totalRaces; i++) {
                        html += `
                            <div class="championship-race">
                                <span>Gara ${i + 1}</span>
                                <span>Da correre</span>
                            </div>
                        `;
                    }

                    html += `
                        </div>
                        <button class="btn btn-purple" onclick="game.runChampionshipRace()" 
                                ${this.championship.currentRace >= this.championship.totalRaces || this.resources.energy.value < 20 ? 'disabled' : ''}>
                            ${this.championship.currentRace >= this.championship.totalRaces ? 'Completato' : 'Corri Gara ' + (this.championship.currentRace + 1)}
                        </button>
                        <button class="btn" onclick="game.abandonChampionship()" style="background: #666; margin-top: 10px;">
                            Abbandona Campionato
                        </button>
                    `;
                    
                    champContainer.innerHTML = html;
                } else {
                    const canStart = this.canAfford({ money: this.championship.entryFee }) && this.ownedCars.length > 0;
                    champContainer.innerHTML = `
                        <div style="background: var(--bg-card); border: 2px solid var(--accent-purple); border-radius: 12px; padding: 30px; text-align: center;">
                            <div style="font-size: 1.5rem; margin-bottom: 20px;">
                                ğŸ† 5 Gare Consecutive
                            </div>
                            <div style="margin: 20px 0;">
                                <div style="margin: 10px 0;">ğŸ’° Quota Iscrizione: ${this.championship.entryFee}â‚¬</div>
                                <div style="margin: 10px 0;">ğŸ† Premio (minimo 3 vittorie): ${this.championship.prizePool}â‚¬</div>
                                <div style="margin: 10px 0;">âš ï¸ Danni garantiti ad ogni gara</div>
                                <div style="margin: 10px 0;">ğŸ’° Ricompense progressive ad ogni vittoria</div>
                            </div>
                            <button class="btn btn-purple" onclick="game.startChampionship()" ${!canStart ? 'disabled' : ''}>
                                Iscriviti al Campionato
                            </button>
                        </div>
                    `;
                }
                
                // Renderizza ultime 10 gare inline
                this.renderHistoryInline();
            },
            
            renderHistoryInline() {
                const container = document.getElementById('raceHistoryInline');
                
                if (this.raceHistory.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“œ</div>
                            <div>Nessuna gara completata</div>
                        </div>
                    `;
                    return;
                }
                
                // Prendi solo le ultime 10 gare
                const last10Races = this.raceHistory.slice(0, 10);
                
                container.innerHTML = last10Races.map((race, index) => {
                    const winClass = race.win ? 'win' : 'lose';
                    return `
                        <div class="championship-race ${winClass}" style="margin: 10px 0; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">${race.date}</div>
                                    <div style="font-weight: 700; margin: 5px 0;">${race.type}</div>
                                </div>
                                <div style="flex: 2; min-width: 300px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="text-align: left;">
                                            <div>${race.playerCar}</div>
                                            <div style="color: var(--accent-cyan);">${race.playerPower} HP</div>
                                        </div>
                                        <div style="font-size: 1.5rem; margin: 0 15px;">
                                            ${race.win ? 'ğŸ†' : 'ğŸ’¥'}
                                        </div>
                                        <div style="text-align: right;">
                                            <div>${race.opponentName}</div>
                                            <div style="color: var(--accent-red);">${race.opponentPower} HP</div>
                                        </div>
                                    </div>
                                </div>
                                <div style="flex: 1; min-width: 150px; text-align: right;">
                                    ${race.win && race.rewards ? `
                                        <div style="font-size: 0.85rem;">
                                            <div>ğŸ’° +${race.rewards.money || 0}</div>
                                            <div>â­ +${race.rewards.reputation || 0}</div>
                                            <div>ğŸ”© +${race.rewards.parts || 0}</div>
                                        </div>
                                    ` : ''}
                                    ${race.damage ? `<div style="color: var(--accent-red); font-size: 0.85rem;">âš ï¸ -${race.damage}%</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderHistory() {
                const container = document.getElementById('raceHistoryContainer');
                
                if (this.raceHistory.length === 0) {
                    container.innerHTML = `
                        <div class="empty-garage">
                            <div class="empty-garage-icon">ğŸ“œ</div>
                            <div>Nessuna gara completata</div>
                            <div style="margin-top: 10px; font-size: 1rem;">Vai alla sezione Gare!</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.raceHistory.map((race, index) => {
                    const winClass = race.win ? 'win' : 'lose';
                    return `
                        <div class="championship-race ${winClass}" style="margin: 10px 0; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">${race.date}</div>
                                    <div style="font-weight: 700; margin: 5px 0;">${race.type}</div>
                                </div>
                                <div style="flex: 2; min-width: 300px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="text-align: left;">
                                            <div>${race.playerCar}</div>
                                            <div style="color: var(--accent-cyan);">${race.playerPower} HP</div>
                                        </div>
                                        <div style="font-size: 1.5rem; margin: 0 15px;">
                                            ${race.win ? 'ğŸ†' : 'ğŸ’¥'}
                                        </div>
                                        <div style="text-align: right;">
                                            <div>${race.opponentName}</div>
                                            <div style="color: var(--accent-red);">${race.opponentPower} HP</div>
                                        </div>
                                    </div>
                                </div>
                                <div style="flex: 1; min-width: 150px; text-align: right;">
                                    ${race.win && race.rewards ? `
                                        <div style="font-size: 0.85rem;">
                                            <div>ğŸ’° +${race.rewards.money || 0}</div>
                                            <div>â­ +${race.rewards.reputation || 0}</div>
                                            <div>ğŸ”© +${race.rewards.parts || 0}</div>
                                        </div>
                                    ` : ''}
                                    ${race.damage ? `<div style="color: var(--accent-red); font-size: 0.85rem;">âš ï¸ -${race.damage}%</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderHistoryInline() {
                const container = document.getElementById('raceHistoryInline');
                
                if (this.raceHistory.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                            <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“œ</div>
                            <div>Nessuna gara ancora completata</div>
                        </div>
                    `;
                    return;
                }

                // Mostra solo le ultime 10 gare
                const recentRaces = this.raceHistory.slice(0, 10);
                
                container.innerHTML = recentRaces.map((race, index) => {
                    const winClass = race.win ? 'win' : 'lose';
                    return `
                        <div class="championship-race ${winClass}" style="margin: 10px 0; padding: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div style="flex: 1; min-width: 150px;">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">${race.date}</div>
                                    <div style="font-weight: 600; font-size: 0.9rem;">${race.type}</div>
                                </div>
                                <div style="flex: 2; min-width: 250px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="text-align: left; font-size: 0.85rem;">
                                            <div>${race.playerCar}</div>
                                            <div style="color: var(--accent-cyan);">${race.playerPower} HP</div>
                                        </div>
                                        <div style="font-size: 1.3rem; margin: 0 10px;">
                                            ${race.win ? 'ğŸ†' : 'ğŸ’¥'}
                                        </div>
                                        <div style="text-align: right; font-size: 0.85rem;">
                                            <div>${race.opponentName}</div>
                                            <div style="color: var(--accent-red);">${race.opponentPower} HP</div>
                                        </div>
                                    </div>
                                </div>
                                ${race.win && race.rewards ? `
                                    <div style="flex: 1; min-width: 120px; text-align: right; font-size: 0.75rem;">
                                        <div>ğŸ’° +${race.rewards.money || 0}</div>
                                        <div>â­ +${race.rewards.reputation || 0}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            },

            async renderLeaderboard() {
                // GUARD: Previeni loop infinito
                if (this._isRenderingLeaderboard) {
                    console.log('âš ï¸ Render leaderboard giÃ  in corso, skip');
                    return;
                }
                
                this._isRenderingLeaderboard = true;
                
                try {
                    const container = document.getElementById('leaderboardContainer');
                    
                    if (!this._leaderboardCache) {
                        container.innerHTML = '<p style="color: #a0a0a0; text-align: center; padding: 40px;">â³ Caricamento classifica...</p>';
                    }

                    const data = await loadLeaderboard();
                    if (!data) {
                        container.innerHTML = '<p style="color: #ff3333; text-align: center; padding: 40px;">âŒ Errore caricamento classifica</p>';
                        return;
                    }

                    this._leaderboardCache = data;

                    // Controlla se puÃ² sfidare oggi (con cache)
                    if (!this._canChallengeCache || (Date.now() - this._canChallengeCacheTime > 60000)) {
                        this._canChallengeCache = await this.checkCanChallenge();
                        this._canChallengeCacheTime = Date.now();
                    }
                    const canChallengeData = this._canChallengeCache;
                    const canChallenge = canChallengeData ? canChallengeData.canChallenge : false;

                const { leaderboard, userRank } = data;
                
                let html = `
                    <div class="page-container">
                        <div class="section-layout">
                            <!-- Menu laterale SX -->
                            <div class="side-menu">
                                <div class="stat-box" style="cursor: default;">
                                    <div class="stat-label">GIOCATORI</div>
                                    <div class="stat-value">${leaderboard.length}</div>
                                </div>
                                <div class="stat-box" style="cursor: default;">
                                    <div class="stat-label">TUA POS.</div>
                                    <div class="stat-value">${userRank ? userRank.rank : leaderboard.findIndex(p => p.username === currentUser?.username) + 1}</div>
                                </div>
                                <div class="stat-box" style="cursor: default;">
                                    <div class="stat-label">TOP 3</div>
                                    <div class="stat-value" style="font-size: 1.5rem;">ğŸ†</div>
                                </div>
                            </div>

                            <!-- Immagine centrale -->
                            <div class="section-image-container">
                                <img src="images/sections/leaderboard.jpg" 
                                     class="section-image" 
                                     alt="Classifica"
                                     onload="console.log('âœ… Immagine leaderboard caricata!');"
                                     onerror="console.error('âŒ Immagine leaderboard non trovata:', this.src); this.style.display='none'; this.parentElement.style.background='linear-gradient(135deg, #1a1a1a, #0a0a0a)'; this.parentElement.innerHTML='<div style=text-align:center;padding-top:100px><div style=font-size:4rem>ğŸ†</div></div>'">
                            </div>

                            <!-- Stats laterale DX -->
                            <div class="side-stats">`;

                html += `
                                <div class="stat-box" style="cursor: default;">
                                    <div class="stat-label" style="font-size: 0.65rem;">AGGIORNAMENTO</div>
                                    <div class="stat-value" style="font-size: 0.75rem; line-height: 1.2;">00:00<br>08:00<br>16:00</div>
                                </div>
                                <div class="stat-box" style="cursor: default; ${!canChallenge ? 'background: rgba(255,51,51,0.1); border-color: var(--accent-red);' : 'background: rgba(0,255,136,0.1); border-color: var(--accent-green);'}">
                                    <div class="stat-label" style="font-size: 0.7rem;">SFIDA PVP</div>
                                    <div class="stat-value" style="font-size: 0.9rem;">${canChallenge ? 'âœ… OK' : 'â° NO'}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Info banner -->
                        <div style="margin-bottom: 15px;">`;

                // Messaggio status sfide
                if (!canChallenge && canChallengeData) {
                    const nextTime = new Date(canChallengeData.nextChallengeTime);
                    const hours = Math.floor((nextTime - new Date()) / (1000 * 60 * 60));
                    const minutes = Math.floor(((nextTime - new Date()) % (1000 * 60 * 60)) / (1000 * 60));
                    
                    html += `<div style="background: rgba(255,51,51,0.2); border: 2px solid var(--accent-red); padding: 12px; border-radius: 10px; text-align: center;">
                        â° Hai giÃ  sfidato un giocatore oggi - Prossima sfida tra <strong>${hours}h ${minutes}m</strong>
                    </div>`;
                }

                html += `</div>

                        <!-- Tabella classifica -->
                        <div style="background: rgba(255,255,255,0.02); padding: 15px; border-radius: 10px; border: 1px solid var(--accent-cyan);">
                            <div style="display: grid; grid-template-columns: 60px 1fr 150px 120px; gap: 10px; padding: 12px; border-bottom: 2px solid var(--accent-yellow); margin-bottom: 10px;">
                                <div style="text-align: center; font-weight: 700; color: var(--accent-yellow);">#</div>
                                <div style="font-weight: 700; color: var(--accent-yellow);">Pilota</div>
                                <div style="text-align: center; font-weight: 700; color: var(--accent-yellow);">Reputazione</div>
                                <div style="text-align: center; font-weight: 700; color: var(--accent-yellow);">Azione</div>
                            </div>`;

                leaderboard.forEach((player, i) => {
                    const isMe = currentUser && player.username === currentUser.username;
                    const rankColor = i === 0 ? '#ffd700' : i === 1 ? '#c0c0c0' : i === 2 ? '#cd7f32' : '#a0a0a0';
                    const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `${i + 1}`;
                    
                    html += `<div style="display: grid; grid-template-columns: 60px 1fr 150px 120px; gap: 10px; padding: 10px; 
                             background: ${isMe ? 'rgba(0,255,136,0.1)' : 'rgba(255,255,255,0.03)'}; 
                             border: ${isMe ? '2px solid #00ff88' : '1px solid rgba(255,255,255,0.05)'};
                             border-radius: 8px; margin-bottom: 5px; align-items: center;">
                        <div style="text-align: center; font-size: 1.2rem; color: ${rankColor}; font-weight: 700;">${medal}</div>
                        <div style="font-size: 1rem; ${isMe ? 'color: #00ff88; font-weight: 700;' : ''}">${player.username} ${isMe ? '(Tu)' : ''}</div>
                        <div style="text-align: center; color: #00d9ff; font-weight: 700;">${Number(player.reputation).toLocaleString()}</div>
                        <div style="text-align: center;">
                            ${!isMe ? `
                                <button 
                                    onclick="game.challengePlayer(${player.user_id}, '${player.username}')" 
                                    class="btn btn-small" 
                                    style="font-size: 0.75rem; padding: 5px 10px; ${!canChallenge ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
                                    ${!canChallenge ? 'disabled' : ''}>
                                    âš”ï¸ Sfida
                                </button>
                            ` : '<span style="color: #00ff88; font-size: 0.85rem;">â€”</span>'}
                        </div>
                    </div>`;
                });

                if (userRank) {
                    html += `<div style="margin-top: 15px; padding: 12px; background: rgba(0,255,136,0.1); border: 2px solid #00ff88; border-radius: 8px; display: grid; grid-template-columns: 60px 1fr 150px 120px; gap: 10px; align-items: center;">
                        <div style="text-align: center; font-weight: 700; color: #00ff88;">${userRank.rank}</div>
                        <div style="color: #00ff88; font-weight: 700;">${userRank.username} (Tu)</div>
                        <div style="text-align: center; color: #00d9ff; font-weight: 700;">${Number(userRank.reputation).toLocaleString()}</div>
                        <div style="text-align: center;"><span style="color: #00ff88; font-size: 0.85rem;">â€”</span></div>
                    </div>`;
                }

                    html += '</div></div>';
                    container.innerHTML = html;
                    
                } finally {
                    // Rilascia flag anche in caso di errore
                    this._isRenderingLeaderboard = false;
                }
            },

            async checkCanChallenge() {
                try {
                    const token = localStorage.getItem('authToken');
                    const response = await fetch(`${API_URL}/api/pvp/can-challenge`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        console.log(`âš ï¸ Endpoint can-challenge: ${response.status} - Sfide abilitate di default`);
                        // Se endpoint non esiste, abilita sfide comunque
                        return { canChallenge: true, nextChallengeTime: null, lastChallengeTime: null };
                    }
                    
                    const data = await response.json();
                    console.log('âœ… Check sfida:', data);
                    return data;
                } catch (error) {
                    console.error('Errore controllo sfida:', error);
                    // In caso di errore, abilita sfide
                    return { canChallenge: true, nextChallengeTime: null, lastChallengeTime: null };
                }
            },

            async challengePlayer(defenderId, defenderUsername) {
                if (this.resources.energy.value < 20) {
                    alert('âš¡ Energia insufficiente!\n\nServono 20 energia per sfidare un giocatore.');
                    return;
                }

                // Salva dati sfida per confirmChallenge
                this._pendingChallenge = { defenderId, defenderUsername };
                
                // Mostra modal conferma
                document.getElementById('challengeOpponentName').textContent = defenderUsername;
                document.getElementById('challengeModal').classList.add('active');
            },

            closeChallengeModal() {
                document.getElementById('challengeModal').classList.remove('active');
                this._pendingChallenge = null;
            },

            async confirmChallenge() {
                if (!this._pendingChallenge) return;
                
                const { defenderId, defenderUsername } = this._pendingChallenge;
                
                // Chiudi modal
                this.closeChallengeModal();

                try {
                    const token = localStorage.getItem('authToken');
                    
                    const response = await fetch(`${API_URL}/api/pvp/challenge`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ defenderId: defenderId })
                    });
                    
                    const result = await response.json();

                    if (!response.ok) {
                        alert(`âŒ ${result.error || 'Errore durante la sfida'}`);
                        return;
                    }

                    // Aggiorna stato locale con quello dal server
                    Object.keys(result.newState).forEach(key => {
                        if (this.hasOwnProperty(key)) {
                            this[key] = result.newState[key];
                        }
                    });

                    // Mostra risultato PvP con modal
                    this.showPvPResult(result, defenderUsername);
                    
                    // Ricarica classifica SOLO se sei in quella pagina
                    this._leaderboardCache = null;
                    leaderboardCache = null;
                    leaderboardCacheSlot = null;
                    if (this.currentPage === 'leaderboard') {
                        this.renderLeaderboard();
                    }

                } catch (error) {
                    console.error('âŒ Errore sfida:', error);
                    alert('âŒ Errore di connessione durante la sfida\n\nDettagli: ' + error.message);
                }
            },

            showPvPResult(result, opponentName) {
                const modal = document.getElementById('raceModal');
                const title = document.getElementById('raceResult');
                const comparison = document.getElementById('raceComparison');
                const rewardsDiv = document.getElementById('raceRewards');
                const damageDiv = document.getElementById('damageSection');
                
                const win = result.win;
                const rewards = result.rewards;
                
                // Titolo
                title.textContent = win ? 'âš”ï¸ VITTORIA PVP!' : 'ğŸ’¥ SCONFITTA PVP';
                title.style.color = win ? 'var(--accent-green)' : 'var(--accent-red)';
                
                // Modal styling
                const modalContent = modal.querySelector('.modal-content');
                modalContent.className = 'modal-content ' + (win ? 'win' : '');
                
                // Confronto auto
                comparison.innerHTML = `
                    <div style="text-align: center;">
                        <h3 style="color: var(--accent-cyan); margin-bottom: 10px;">ğŸï¸ TUA AUTO</h3>
                        <p style="font-size: 1.2rem; font-weight: 700;">${result.attacker.car}</p>
                        <p style="color: var(--accent-yellow); font-size: 1.5rem; font-weight: 900;">${result.attacker.power} HP</p>
                    </div>
                    <div style="text-align: center;">
                        <h3 style="color: var(--accent-red); margin-bottom: 10px;">ğŸï¸ ${opponentName.toUpperCase()}</h3>
                        <p style="font-size: 1.2rem; font-weight: 700;">${result.defender.car}</p>
                        <p style="color: var(--accent-yellow); font-size: 1.5rem; font-weight: 900;">${result.defender.power} HP</p>
                    </div>
                `;
                
                // Rewards
                const sign = win ? '+' : '-';
                const color = win ? 'var(--accent-green)' : 'var(--accent-red)';
                rewardsDiv.innerHTML = `
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h3 style="text-align: center; margin-bottom: 15px; color: ${color};">${win ? 'BOTTINO' : 'PERDITE'}</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                            <div>
                                <div style="font-size: 0.85rem; color: #a0a0a0;">Denaro</div>
                                <div style="font-size: 1.5rem; font-weight: 900; color: ${color};">${sign}${rewards.money}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: #a0a0a0;">Parti</div>
                                <div style="font-size: 1.5rem; font-weight: 900; color: ${color};">${sign}${rewards.parts}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: #a0a0a0;">Reputazione</div>
                                <div style="font-size: 1.5rem; font-weight: 900; color: ${color};">${sign}${rewards.reputation}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // No damage section per PvP
                damageDiv.innerHTML = '';
                
                modal.classList.add('active');
            },

            resetGame() {
                if (confirm('Sei sicuro di voler resettare il gioco?')) {
                    localStorage.removeItem('garageRacingGame');
                    location.reload();
                }
            }
        };

// ===== AVVIO APPLICAZIONE =====
function toggleMobileMenu() {
    try {
        const menu = document.getElementById('mobileMenu');
        if (menu) {
            menu.classList.toggle('active');
            console.log('Menu mobile toggled');
        } else {
            console.error('Menu mobile non trovato');
        }
    } catch (error) {
        console.error('Errore toggle menu:', error);
    }
}

function closeMobileMenu() {
    try {
        const menu = document.getElementById('mobileMenu');
        if (menu) {
            menu.classList.remove('active');
        }
    } catch (error) {
        console.error('Errore chiusura menu:', error);
    }
}

window.addEventListener('load', async () => {
    console.log('ğŸš€ Applicazione caricata');
    
    if (!authToken) {
        console.log('âš ï¸ Nessun token - Mostra login');
        showAuthModal();
    } else {
        console.log('âœ… Token trovato - Inizializza gioco');
        await game.init();
    }
});
    </script>
</body>
</html>
